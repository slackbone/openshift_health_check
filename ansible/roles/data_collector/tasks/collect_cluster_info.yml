---
- name: Collect cluster information
  block:
    - name: Get cluster info
      command: "{{ cli_command }} cluster-info"
      register: cluster_info_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"

    - name: Get cluster version details
      command: "{{ cli_command }} get clusterversion -o json"
      register: cluster_version_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"
      failed_when: false

    - name: Get nodes overview (JSON)
      command: "{{ cli_command }} get nodes -o json"
      register: nodes_overview_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"
      failed_when: false

    - name: Get namespaces overview (JSON)
      command: "{{ cli_command }} get namespaces -o json"
      register: namespaces_overview_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"
      failed_when: false

    - name: Parse cluster version JSON for payload
      set_fact:
        _cluster_version_dict: "{{ (cluster_version_result.stdout | default('{}')) | from_json }}"
      when: cluster_version_result.stdout is defined and (cluster_version_result.stdout | length) > 0
      ignore_errors: true

    - name: Parse nodes overview JSON for payload
      set_fact:
        _nodes_overview_dict: "{{ (nodes_overview_result.stdout | default('{}')) | from_json }}"
      when: nodes_overview_result.stdout is defined and (nodes_overview_result.stdout | length) > 0
      ignore_errors: true

    - name: Parse namespaces overview JSON for payload
      set_fact:
        _namespaces_overview_dict: "{{ (namespaces_overview_result.stdout | default('{}')) | from_json }}"
      when: namespaces_overview_result.stdout is defined and (namespaces_overview_result.stdout | length) > 0
      ignore_errors: true

    - name: Build cluster info dict (all JSON from CLI where supported)
      set_fact:
        _cluster_info_payload:
          cluster_info: "{{ cluster_info_result.stdout | default('') }}"
          cluster_version: "{{ _cluster_version_dict | default({}) }}"
          nodes_json: "{{ _nodes_overview_dict | default({}) }}"
          namespaces_json: "{{ _namespaces_overview_dict | default({}) }}"
          collection_metadata: "{{ collection_metadata | default({}) }}"

    - name: Save cluster info to file (JSON from CLI; cluster-info Ãºnico texto sem -o json)
      copy:
        content: "{{ _cluster_info_payload | to_nice_json }}"
        dest: "{{ data_output_dir }}/cluster_info.json"
        mode: '0644'

    - name: Set fact for cluster info collection status
      set_fact:
        collection_status:
          cluster_info: true

    - name: Display cluster info collection status
      debug:
        msg: "Cluster information collected successfully"

  rescue:
    - name: Handle cluster info collection failure
      debug:
        msg: "Failed to collect cluster information: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for cluster info collection status
      set_fact:
        collection_status:
          cluster_info: false

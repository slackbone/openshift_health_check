---
- name: Collect nodes information
  block:
    - name: Get nodes detailed information (JSON; labels em metadata.labels)
      command: "{{ cli_command }} get nodes -o json"
      register: nodes_json_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"

    - name: Get machine config pools (OpenShift specific)
      command: "{{ cli_command }} get machineconfigpools -o json"
      register: machine_config_pools_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"
      failed_when: false

    - name: Get machines (OpenShift specific)
      command: "{{ cli_command }} get machines -A -o json"
      register: machines_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"
      failed_when: false

    - name: Parse nodes JSON for payload
      set_fact:
        _nodes_json_dict: "{{ (nodes_json_result.stdout | default('{}')) | from_json }}"
      when: nodes_json_result.stdout is defined and (nodes_json_result.stdout | length) > 0
      ignore_errors: true

    - name: Parse machine config pools JSON for payload
      set_fact:
        _mcp_dict: "{{ (machine_config_pools_result.stdout | default('{}')) | from_json }}"
      when: machine_config_pools_result.stdout is defined and (machine_config_pools_result.stdout | length) > 0
      ignore_errors: true

    - name: Parse machines JSON for payload
      set_fact:
        _machines_dict: "{{ (machines_result.stdout | default('{}')) | from_json }}"
      when: machines_result.stdout is defined and (machines_result.stdout | length) > 0
      ignore_errors: true

    - name: Build nodes_labels list from nodes JSON (name + labels per node)
      set_fact:
        _nodes_labels_list: "{{ _nodes_labels_list | default([]) + [{'name': item.metadata.name | default(''), 'labels': item.metadata.labels | default({})}] }}"
      loop: "{{ (_nodes_json_dict | default({})).get('items', []) }}"
      when: (_nodes_json_dict | default({})).get('items', []) | length > 0

    - name: Build nodes payload dict (all JSON; labels derivados de nodes_json)
      set_fact:
        _nodes_payload:
          nodes_json: "{{ _nodes_json_dict | default({}) }}"
          nodes_labels: "{{ _nodes_labels_list | default([]) }}"
          machine_config_pools: "{{ _mcp_dict | default({}) }}"
          machines: "{{ _machines_dict | default({}) }}"
          collection_metadata: "{{ collection_metadata | default({}) }}"

    - name: Save nodes data to file (tudo JSON; sem sa√≠da texto)
      copy:
        content: "{{ _nodes_payload | to_nice_json }}"
        dest: "{{ data_output_dir }}/nodes.json"
        mode: '0644'

    - name: Set fact for nodes collection status
      set_fact:
        collection_status:
          nodes: true

    - name: Display nodes collection status
      debug:
        msg: "Nodes information collected successfully"

  rescue:
    - name: Handle nodes collection failure
      debug:
        msg: "Failed to collect nodes information: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for nodes collection status
      set_fact:
        collection_status:
          nodes: false

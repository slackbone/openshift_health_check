---
# Coleta de security configs feita no host remoto para evitar transferir
# grandes JSONs ao controlador (evita "No space left on device" e worker dead).
- name: Collect security configurations
  block:
    - name: Write collection_metadata for security configs on remote
      copy:
        content: "{{ collection_metadata | to_nice_json }}"
        dest: "{{ data_output_dir }}/.security_metadata.json"
        mode: '0600'

    - name: Copy merge script for security configs to remote
      copy:
        src: merge_security_configs_json.py
        dest: "{{ data_output_dir }}/merge_security_configs_json.py"
        mode: '0755'

    # Usa sempre Python para merge: lê e apaga cada arquivo após leitura, reduzindo pico de disco
    - name: Fetch security configs and build security_configs.json on remote
      shell: |
        set -e
        export KUBECONFIG="{{ openshift_kubeconfig }}"
        cd "{{ data_output_dir }}"
        {{ cli_command }} get securitycontextconstraints -o json > _scc.json 2>/dev/null || echo '{}' > _scc.json
        {{ cli_command }} get networkpolicies --all-namespaces -o json > _np.json 2>/dev/null || echo '{}' > _np.json
        {{ cli_command }} get podsecuritypolicies --all-namespaces -o json > _psp.json 2>/dev/null || echo '{}' > _psp.json
        {{ cli_command }} get secrets --all-namespaces -o json > _secrets.json 2>/dev/null || echo '{}' > _secrets.json
        {{ cli_command }} get configmaps --all-namespaces -o json > _cm.json 2>/dev/null || echo '{}' > _cm.json
        python3 merge_security_configs_json.py
      args:
        executable: /bin/bash
      register: security_configs_build_result
      failed_when: security_configs_build_result.rc != 0
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"

    - name: Set fact for security configs collection status
      set_fact:
        collection_status:
          security_configs: true

    - name: Display security configs collection status
      debug:
        msg: "Security configurations collected successfully (built on remote)"

  rescue:
    - name: Handle security configs collection failure
      debug:
        msg: "Failed to collect security configurations: {{ ansible_failed_result.msg }}"

    - name: Set fact for security configs collection status
      set_fact:
        collection_status:
          security_configs: false

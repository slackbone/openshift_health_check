---
# Coleta de operators feita inteiramente no host remoto para evitar transferir
# grandes JSONs ao controlador (evita "worker dead" em máquinas com poucos CPUs).
- name: Collect operators information (on remote host)
  block:
    - name: Write collection_metadata to temp file on remote
      copy:
        content: "{{ collection_metadata | to_nice_json }}"
        dest: "{{ data_output_dir }}/.operators_metadata.json"
        mode: '0600'

    - name: Copy merge script to remote (fallback when jq is not available)
      copy:
        src: merge_operators_json.py
        dest: "{{ data_output_dir }}/merge_operators_json.py"
        mode: '0755'

    # Usa sempre Python para merge: lê e apaga cada arquivo após leitura, reduzindo pico de disco
    # (jq exigiria todos os arquivos em disco ao mesmo tempo; com /tmp de 600 MB no bastion falha)
    - name: Fetch operators data and build operators.json on remote
      shell: |
        set -e
        export KUBECONFIG="{{ openshift_kubeconfig }}"
        cd "{{ data_output_dir }}"
        {{ cli_command }} get clusterserviceversions --all-namespaces -o json > _csv.json
        {{ cli_command }} get subscriptions --all-namespaces -o json > _sub.json
        {{ cli_command }} get installplans --all-namespaces -o json > _ip.json
        {{ cli_command }} get operatorgroups --all-namespaces -o json > _og.json
        {{ cli_command }} get catalogs --all-namespaces -o json > _cat.json 2>/dev/null || echo '{}' > _cat.json
        python3 merge_operators_json.py
      args:
        executable: /bin/bash
      register: operators_build_result
      no_log: true
      failed_when: operators_build_result.rc != 0
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"

    - name: Set fact for operators collection status
      set_fact:
        collection_status:
          operators: true

    - name: Display operators collection status
      debug:
        msg: "Operators information collected successfully (built on remote)"

  rescue:
    - name: Handle operators collection failure
      debug:
        msg: "Failed to collect operators information: {{ ansible_failed_result.msg }}"

    - name: Set fact for operators collection status
      set_fact:
        collection_status:
          operators: false

---
- name: Consolidate collected data
  block:
    - name: Create consolidated data summary
      set_fact:
        consolidated_data:
          collection_summary:
            timestamp: "{{ collection_metadata.collection_timestamp }}"
            cluster_url: "{{ collection_metadata.cluster_url }}"
            cli_command: "{{ collection_metadata.cli_command }}"
            collection_host: "{{ collection_metadata.collection_host }}"
            ansible_version: "{{ collection_metadata.ansible_version }}"
            collection_status: "{{ collection_status | default({}) }}"
          data_files:
            cluster_info: "{{ 'cluster_info.json' if (collection_status | default({})).cluster_info | default(false) | bool else '' }}"
            nodes: "{{ 'nodes.json' if (collection_status | default({})).nodes | default(false) | bool else '' }}"
            namespaces: "{{ 'namespaces.json' if (collection_status | default({})).namespaces | default(false) | bool else '' }}"
            pods: "{{ 'pods.json' if (collection_status | default({})).pods | default(false) | bool else '' }}"
            services: "{{ 'services.json' if (collection_status | default({})).services | default(false) | bool else '' }}"
            deployments: "{{ 'deployments.json' if (collection_status | default({})).deployments | default(false) | bool else '' }}"
            rbac: "{{ 'rbac.json' if (collection_status | default({})).rbac | default(false) | bool else '' }}"
            security_configs: "{{ 'security_configs.json' if (collection_status | default({})).security_configs | default(false) | bool else '' }}"
            operators: "{{ 'operators.json' if (collection_status | default({})).operators | default(false) | bool else '' }}"
            metrics: "{{ 'metrics.json' if (collection_status | default({})).metrics | default(false) | bool else '' }}"
            events: "{{ 'events.json' if (collection_status | default({})).events | default(false) | bool else '' }}"

    - name: Save consolidated data summary
      copy:
        content: "{{ consolidated_data | to_nice_json }}"
        dest: "{{ data_output_dir }}/collection_summary.json"
        mode: '0644'

    - name: Create data collection report
      template:
        src: data_collection_report.j2
        dest: "{{ data_output_dir }}/data_collection_report.md"
        mode: '0644'

    - name: Compress data directory if requested
      shell: tar -czf "{{ data_output_dir }}.tar.gz" -C "{{ data_output_dir | dirname }}" "{{ data_output_dir | basename }}"
      args:
        creates: "{{ data_output_dir }}.tar.gz"
      when: compress_data | bool
      changed_when: false

    - name: Set fact for data collection completion
      set_fact:
        data_collection_completed: true
        data_output_path: "{{ data_output_dir }}"

    - name: Display data collection summary
      debug:
        msg: |
          Data collection completed!
          
          Collection Status:
          - Cluster Info: {{ '✓' if (collection_status | default({})).cluster_info | default(false) else '✗' }}
          - Nodes: {{ '✓' if (collection_status | default({})).nodes | default(false) else '✗' }}
          - Namespaces: {{ '✓' if (collection_status | default({})).namespaces | default(false) else '✗' }}
          - Pods: {{ '✓' if (collection_status | default({})).pods | default(false) else '✗' }}
          - Services: {{ '✓' if (collection_status | default({})).services | default(false) else '✗' }}
          - Deployments: {{ '✓' if (collection_status | default({})).deployments | default(false) else '✗' }}
          - RBAC: {{ '✓' if (collection_status | default({})).rbac | default(false) else '✗' }}
          - Security Configs: {{ '✓' if (collection_status | default({})).security_configs | default(false) else '✗' }}
          - Operators: {{ '✓' if (collection_status | default({})).operators | default(false) else '✗' }}
          - Metrics: {{ '✓' if (collection_status | default({})).metrics | default(false) else '✗' }}
          - Events: {{ '✓' if (collection_status | default({})).events | default(false) else '✗' }}
          
          Data saved to: {{ data_output_dir }}

  rescue:
    - name: Handle data consolidation failure
      debug:
        msg: "Failed to consolidate collected data: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for data collection completion
      set_fact:
        data_collection_completed: false

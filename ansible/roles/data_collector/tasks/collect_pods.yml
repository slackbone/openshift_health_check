---
- name: Collect pods information
  block:
    - name: Get pods detailed information (JSON; labels em metadata.labels)
      command: "{{ cli_command }} get pods --all-namespaces -o json"
      register: pods_json_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"

    - name: Get pod templates
      command: "{{ cli_command }} get podtemplates --all-namespaces -o json"
      register: pod_templates_result
      no_log: true
      environment: "{{ cluster_env | default({'KUBECONFIG': openshift_kubeconfig}) }}"
      failed_when: false

    - name: Parse pods JSON for payload
      set_fact:
        _pods_json_dict: "{{ (pods_json_result.stdout | default('{}')) | from_json }}"
      when: pods_json_result.stdout is defined and (pods_json_result.stdout | length) > 0
      ignore_errors: true

    - name: Parse pod templates JSON for payload
      set_fact:
        _pod_templates_dict: "{{ (pod_templates_result.stdout | default('{}')) | from_json }}"
      when: pod_templates_result.stdout is defined and (pod_templates_result.stdout | length) > 0
      ignore_errors: true

    - name: Build pods_labels list from pods JSON (uma tarefa, sem loop por pod)
      set_fact:
        _pods_labels_list: "{{ (_pods_json_dict | default({})) | json_query('items[*].{namespace: metadata.namespace, name: metadata.name, labels: metadata.labels}') | default([]) }}"

    - name: Build pods payload dict (all JSON; labels derivados de pods_json)
      set_fact:
        _pods_payload:
          pods_json: "{{ _pods_json_dict | default({}) }}"
          pods_labels: "{{ _pods_labels_list | default([]) }}"
          pod_templates: "{{ _pod_templates_dict | default({}) }}"
          collection_metadata: "{{ collection_metadata | default({}) }}"

    - name: Save pods data to file (tudo JSON; sem sa√≠da texto)
      copy:
        content: "{{ _pods_payload | to_nice_json }}"
        dest: "{{ data_output_dir }}/pods.json"
        mode: '0644'

    - name: Set fact for pods collection status
      set_fact:
        collection_status:
          pods: true

    - name: Display pods collection status
      debug:
        msg: "Pods information collected successfully"

  rescue:
    - name: Handle pods collection failure
      debug:
        msg: "Failed to collect pods information: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for pods collection status
      set_fact:
        collection_status:
          pods: false

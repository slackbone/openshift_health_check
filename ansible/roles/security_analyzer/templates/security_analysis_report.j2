# Verificação de Saúde OpenShift - Relatório de Análise de Segurança

{% set rbac_analysis = security_analysis.get('rbac_analysis', {}) if security_analysis is defined else {} %}
{% set pod_security = security_analysis.get('pod_security', {}) if security_analysis is defined else {} %}
{% set network_security = security_analysis.get('network_security', {}) if security_analysis is defined else {} %}
{% set secrets_management = security_analysis.get('secrets_management', {}) if security_analysis is defined else {} %}
{% set compliance = security_analysis.get('compliance', {}) if security_analysis is defined else {} %}

## Resumo da Análise

**Timestamp da Análise:** {{ security_analysis.get('analysis_timestamp', 'Unknown') if security_analysis is defined else 'Unknown' }}  
**URL do Cluster:** {{ security_analysis.get('cluster_url', 'N/A') if security_analysis is defined else 'N/A' }}  
**Pontuação Geral de Segurança:** {{ security_analysis.get('overall_security_score', 0) if security_analysis is defined else 0 }}/100  

## Status da Análise

| Componente | Status |
|------------|--------|
| Análise RBAC | {{ 'Sucesso' if security_analysis_status.get('rbac_analysis', false) else 'Falhou' }} |
| Segurança de Rede | {{ 'Sucesso' if security_analysis_status.get('network_security_analysis', false) else 'Falhou' }} |
| Segurança de Pods | {{ 'Sucesso' if security_analysis_status.get('pod_security', false) else 'Falhou' }} |
| Gerenciamento de Segredos | {{ 'Sucesso' if security_analysis_status.get('secrets_management_analysis', false) else 'Falhou' }} |
| Análise de Conformidade | {{ 'Sucesso' if security_analysis_status.get('compliance_analysis', false) else 'Falhou' }} |

## Análise RBAC

{% if security_analysis_status.get('rbac_analysis', false) and rbac_analysis %}
- **Total de Roles do Cluster:** {{ rbac_analysis.get('cluster_roles', {}).get('total_cluster_roles', 0) }}
- **Roles de Administrador do Cluster:** {{ rbac_analysis.get('cluster_roles', {}).get('cluster_admin_roles', 0) }}
- **Roles do Sistema:** {{ rbac_analysis.get('cluster_roles', {}).get('system_roles', 0) }}
- **Roles Personalizados:** {{ rbac_analysis.get('cluster_roles', {}).get('custom_roles', 0) }}
- **Total de Vinculações de Roles do Cluster:** {{ rbac_analysis.get('cluster_role_bindings', {}).get('total_bindings', 0) }}
- **Vinculações de Administrador do Cluster:** {{ rbac_analysis.get('cluster_role_bindings', {}).get('cluster_admin_bindings', 0) }}
- **Total de Contas de Serviço:** {{ rbac_analysis.get('service_accounts', {}).get('total_service_accounts', 0) }}

{% if rbac_analysis.get('excessive_permissions', []) | length > 0 %}
### Permissões Excessivas
{% for permission in rbac_analysis.get('excessive_permissions', []) %}
- AVISO: {{ permission }}
{% endfor %}
{% endif %}

{% if rbac_analysis.get('privileged_accounts', []) | length > 0 %}
### Contas Privilegiadas
{% for account in rbac_analysis.get('privileged_accounts', []) %}
- AVISO: {{ account }}
{% endfor %}
{% endif %}

{% if rbac_analysis.get('issues', []) | length > 0 %}
### Problemas RBAC
{% for issue in rbac_analysis.get('issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise RBAC falhou
{% endif %}

## Análise de Segurança de Pods

{% if security_analysis_status.get('pod_security', false) and pod_security %}
- **Total de Pods:** {{ (pod_security.get('privileged_containers', 0) | int) + (pod_security.get('root_containers', 0) | int) + (pod_security.get('host_network_pods', 0) | int) }}
- **Containers Privilegiados:** {{ pod_security.get('privileged_containers', 0) }}
- **Containers Root:** {{ pod_security.get('root_containers', 0) }}
- **Pods com Rede do Host:** {{ pod_security.get('host_network_pods', 0) }}
- **Pods com PID do Host:** {{ pod_security.get('host_pid_pods', 0) }}
- **Pods com IPC do Host:** {{ pod_security.get('host_ipc_pods', 0) }}
- **Restrições de Contexto de Segurança:** {{ pod_security.get('security_context_constraints', {}).get('total_sccs', 0) }}
- **Políticas de Segurança de Pods:** {{ pod_security.get('pod_security_policies', 0) }}

{% if pod_security.get('pod_security_issues', []) | length > 0 %}
### Problemas de Segurança de Pods
{% for issue in pod_security.get('pod_security_issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise de segurança de pods falhou
{% endif %}

## Recomendações de Segurança

### Alta Prioridade
{% if security_analysis_status.get('rbac_analysis', false) and (rbac_analysis.get('cluster_role_bindings', {}).get('cluster_admin_bindings', 0) | int) > 3 %}
- Reduzir o uso do role cluster-admin ao mínimo necessário
{% endif %}
{% if security_analysis_status.get('pod_security', false) and (pod_security.get('privileged_containers', 0) | int) > 0 %}
- Remover containers privilegiados ou implementar contextos de segurança adequados
{% endif %}
{% if security_analysis_status.get('pod_security', false) and (pod_security.get('root_containers', 0) | int) > 0 %}
- Evitar executar containers como usuário root
{% endif %}

### Média Prioridade
{% if security_analysis_status.get('rbac_analysis', false) and rbac_analysis.get('excessive_permissions', []) | length > 0 %}
- Revisar e minimizar permissões excessivas
{% endif %}
{% if security_analysis_status.get('pod_security', false) and (pod_security.get('host_network_pods', 0) | int) > 0 %}
- Evitar usar rede do host para pods quando possível
{% endif %}

### Baixa Prioridade
{% if security_analysis_status.get('rbac_analysis', false) and rbac_analysis.get('privileged_accounts', []) | length > 0 %}
- Revisar contas de serviço com privilégios elevados
{% endif %}

## Detalhamento da Pontuação de Segurança

**Pontuação Geral:** {{ security_analysis.get('overall_security_score', 0) if security_analysis is defined else 0 }}/100

{% set security_score_int = (security_analysis.get('overall_security_score', 0) | int) if security_analysis is defined else 0 %}
{% if security_score_int >= 90 %}
**Excelente** - A segurança do cluster está bem configurada
{% elif security_score_int >= 70 %}
**Bom** - Algumas melhorias de segurança recomendadas
{% elif security_score_int >= 50 %}
**Regular** - Várias questões de segurança precisam de atenção
{% else %}
**Ruim** - Melhorias significativas de segurança necessárias
{% endif %}

## Estatísticas da Análise

{% set success_count = 0 %}
{% set total_count = 0 %}
{% for key, value in security_analysis_status.items() %}
{% set total_count = total_count + 1 %}
{% if value %}
{% set success_count = success_count + 1 %}
{% endif %}
{% endfor %}

**Total de Componentes de Análise:** {{ total_count }}  
**Análises Bem-sucedidas:** {{ success_count }}  
**Análises Falharam:** {{ total_count - success_count }}  
**Taxa de Sucesso:** {{ ((success_count / total_count) * 100) | round(2) }}%  

## Notas

{% if success_count < total_count %}
**AVISO:** Algumas tarefas de análise de segurança falharam. A análise pode estar incompleta.
{% else %}
**SUCESSO:** Todas as tarefas de análise de segurança foram concluídas com sucesso.
{% endif %}

Este relatório foi gerado automaticamente pelo playbook de Verificação de Saúde OpenShift do Ansible.

---
- name: Analyze RBAC
  block:
    - name: Load RBAC data
      include_vars:
        file: "{{ data_output_path }}/rbac.json"
        name: rbac_data
      when: 
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true

    - name: Set default RBAC data if not available
      set_fact:
        rbac_data:
          clusterroles_json: '{"items": []}'
          clusterrolebindings_json: '{"items": []}'
          roles_json: '{"items": []}'
          rolebindings_json: '{"items": []}'
          serviceaccounts_json: '{"items": []}'
      when: (rbac_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool)

    - name: Parse RBAC data
      set_fact:
        cluster_roles_raw: "{{ rbac_data.clusterroles_json | default('{\"items\": []}') | from_json }}"
        cluster_role_bindings_raw: "{{ rbac_data.clusterrolebindings_json | default('{\"items\": []}') | from_json }}"
        roles_raw: "{{ rbac_data.roles_json | default('{\"items\": []}') | from_json }}"
        role_bindings_raw: "{{ rbac_data.rolebindings_json | default('{\"items\": []}') | from_json }}"
        service_accounts_raw: "{{ rbac_data.serviceaccounts_json | default('{\"items\": []}') | from_json }}"
      when: rbac_data is defined

    - name: Ensure RBAC lists are dicts with items
      set_fact:
        cluster_roles: "{{ cluster_roles_raw | default({'items': []}) }}"
        cluster_role_bindings: "{{ cluster_role_bindings_raw | default({'items': []}) }}"
        roles: "{{ roles_raw | default({'items': []}) }}"
        role_bindings: "{{ role_bindings_raw | default({'items': []}) }}"
        service_accounts: "{{ service_accounts_raw | default({'items': []}) }}"
        cluster_roles_items: "{{ (cluster_roles.get('items', [])) if (cluster_roles is mapping) else [] }}"
        cluster_role_bindings_items: "{{ (cluster_role_bindings.get('items', [])) if (cluster_role_bindings is mapping) else [] }}"
        roles_items: "{{ (roles.get('items', [])) if (roles is mapping) else [] }}"
        role_bindings_items: "{{ (role_bindings.get('items', [])) if (role_bindings is mapping) else [] }}"
        service_accounts_items: "{{ (service_accounts.get('items', [])) if (service_accounts is mapping) else [] }}"

    - name: Analyze cluster roles
      set_fact:
        cluster_roles_analysis:
          total_cluster_roles: "{{ cluster_roles_items | length }}"
          cluster_admin_roles: "{{ cluster_roles_items | selectattr('metadata.name', 'equalto', 'cluster-admin') | list | length }}"
          system_roles: "{{ cluster_roles_items | selectattr('metadata.name', 'match', '^system:') | list | length }}"
          custom_roles: "{{ cluster_roles_items | rejectattr('metadata.name', 'match', '^(cluster-admin|system:)') | list | length }}"

    - name: Analyze cluster role bindings
      set_fact:
        cluster_role_bindings_analysis:
          total_bindings: "{{ cluster_role_bindings_items | length }}"
          cluster_admin_bindings: "{{ cluster_role_bindings_items | selectattr('roleRef.name', 'equalto', 'cluster-admin') | list | length }}"
          system_bindings: "{{ cluster_role_bindings_items | selectattr('roleRef.name', 'match', '^system:') | list | length }}"
          custom_bindings: "{{ cluster_role_bindings_items | rejectattr('roleRef.name', 'match', '^(cluster-admin|system:)') | list | length }}"

    - name: Analyze roles
      set_fact:
        roles_analysis:
          total_roles: "{{ roles_items | length }}"
          roles_by_namespace: "{{ roles_items | groupby('metadata.namespace') | map('first') | list }}"

    - name: Analyze role bindings
      set_fact:
        role_bindings_analysis:
          total_bindings: "{{ role_bindings_items | length }}"
          bindings_by_namespace: "{{ role_bindings_items | groupby('metadata.namespace') | map('first') | list }}"

    - name: Analyze service accounts
      set_fact:
        service_accounts_analysis:
          total_service_accounts: "{{ service_accounts_items | length }}"
          service_accounts_by_namespace: "{{ service_accounts_items | groupby('metadata.namespace') | map('first') | list }}"
          default_service_accounts: "{{ service_accounts_items | selectattr('metadata.name', 'equalto', 'default') | list | length }}"

    - name: Initialize excessive permissions
      set_fact:
        excessive_permissions: []

    - name: Check for excessive permissions
      block:
        - name: Check for cluster-admin usage
          set_fact:
            excessive_permissions: "{{ excessive_permissions + ['Cluster-admin role is being used: ' + (cluster_role_bindings_analysis.cluster_admin_bindings | int | string) + ' bindings'] }}"
          when: 
            - cluster_role_bindings_analysis is defined
            - cluster_role_bindings_analysis.cluster_admin_bindings is defined
            - (cluster_role_bindings_analysis.cluster_admin_bindings | int) > 0
            - check_cluster_admin_usage | bool

        - name: Check for wildcard permissions
          set_fact:
            excessive_permissions: "{{ excessive_permissions + ['Some roles may have wildcard permissions'] }}"
          when: cluster_roles_items | selectattr('rules', 'defined') | selectattr('rules', 'selectattr', 'verbs', 'defined') | selectattr('rules', 'selectattr', 'verbs', 'contains', '*') | list | length > 0

    - name: Initialize privileged accounts
      set_fact:
        privileged_accounts: []

    - name: Check for privileged service accounts
      block:
        - name: Check for service accounts with cluster-admin
          set_fact:
            privileged_accounts: "{{ privileged_accounts + ['Service accounts with cluster-admin role detected'] }}"
          when: cluster_role_bindings_items | selectattr('roleRef.name', 'equalto', 'cluster-admin') | selectattr('subjects', 'defined') | selectattr('subjects', 'selectattr', 'kind', 'equalto', 'ServiceAccount') | list | length > 0

    - name: Initialize RBAC issues
      set_fact:
        rbac_issues: []

    - name: Check RBAC issues
      block:
        - name: Check for excessive cluster-admin usage
          set_fact:
            rbac_issues: "{{ rbac_issues + ['Excessive use of cluster-admin role'] }}"
          when: (cluster_role_bindings_analysis.cluster_admin_bindings | int) > 3

        - name: Check for missing RBAC policies
          set_fact:
            rbac_issues: "{{ rbac_issues + ['Some namespaces may not have proper RBAC policies'] }}"
          when: (role_bindings_items | length) < ((service_accounts_items | length) * 0.5)

    - name: Update security analysis with RBAC analysis
      set_fact:
        security_analysis:
          rbac_analysis:
            cluster_roles: "{{ cluster_roles_analysis }}"
            cluster_role_bindings: "{{ cluster_role_bindings_analysis }}"
            roles: "{{ roles_items | length }}"
            role_bindings: "{{ role_bindings_items | length }}"
            service_accounts: "{{ service_accounts_analysis }}"
            excessive_permissions: "{{ excessive_permissions }}"
            privileged_accounts: "{{ privileged_accounts }}"
            issues: "{{ rbac_issues }}"

    - name: Set fact for RBAC analysis status
      set_fact:
        security_analysis_status:
          rbac_analysis: true

    - name: Display RBAC analysis status
      debug:
        msg: "RBAC analysis completed successfully"

  rescue:
    - name: Handle RBAC analysis failure
      debug:
        msg: "Failed to analyze RBAC: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for RBAC analysis status
      set_fact:
        security_analysis_status:
          rbac_analysis: false

---
- name: Analyze network security
  block:
    - name: Set default network security analysis
      set_fact:
        network_security_analysis:
          network_policies:
            total_policies: 0
            policies_by_namespace: {}
          ingress_controllers:
            total_controllers: 0
            controllers_list: []
          issues: ["Network security analysis limited - detailed network data not collected"]

    - name: Load network-related data from host
      slurp:
        src: "{{ data_output_path }}/services.json"
      register: services_sec_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Load security configs for network policies from host
      slurp:
        src: "{{ data_output_path }}/security_configs.json"
      register: security_sec_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Set services_data from slurped content (security)
      set_fact:
        services_data: "{{ (services_sec_slurp.content | b64decode) | from_json }}"
      when:
        - services_sec_slurp is defined
        - services_sec_slurp.content is defined
        - (services_sec_slurp.content | length) > 0

    - name: Set security_data from slurped content (security)
      set_fact:
        security_data: "{{ (security_sec_slurp.content | b64decode) | from_json }}"
      when:
        - security_sec_slurp is defined
        - security_sec_slurp.content is defined
        - (security_sec_slurp.content | length) > 0

    - name: Set default network data if not available
      set_fact:
        services_data:
          services_json: '{"items": []}'
          ingresses_json: '{"items": []}'
        security_data:
          networkpolicies_json: '{"items": []}'
      when: (services_data is not defined) or (security_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool) or (services_sec_slurp is not defined) or ((services_sec_slurp.content | default('')) | length == 0) or (security_sec_slurp is not defined) or ((security_sec_slurp.content | default('')) | length == 0)

    # Aceitar *_json j√° como dict (slurp+from_json) ou como string (from_json)
    - name: Parse network security data
      set_fact:
        ingresses_list_raw: "{{ (services_data.ingresses_json if (services_data.ingresses_json is defined and services_data.ingresses_json is mapping) else (services_data.ingresses_json | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
        network_policies_list_raw: "{{ (security_data.networkpolicies_json if (security_data.networkpolicies_json is defined and security_data.networkpolicies_json is mapping) else (security_data.networkpolicies_json | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
      when: services_data is defined and security_data is defined

    - name: Ensure network lists are dicts with items
      set_fact:
        ingresses_list: "{{ ingresses_list_raw | default({'items': []}) }}"
        network_policies_list: "{{ network_policies_list_raw | default({'items': []}) }}"
        ingresses_list_items: "{{ (ingresses_list.get('items', [])) if (ingresses_list is mapping) else [] }}"
        network_policies_list_items: "{{ (network_policies_list.get('items', [])) if (network_policies_list is mapping) else [] }}"
        network_policies_list_items_filtered: "{{ network_policies_list_items | select('mapping') | list }}"

    - name: Analyze network policies
      set_fact:
        network_security_analysis:
          network_policies:
            total_policies: "{{ network_policies_list_items_filtered | length }}"
            policies_by_namespace: "{{ network_policies_list_items_filtered | groupby('metadata.namespace') | map('first') | list }}"
          ingress_controllers:
            total_controllers: "{{ ingresses_list_items | length }}"
            controllers_list: "{{ ingresses_list_items }}"
          issues: []

    - name: Check for missing network policies
      set_fact:
        network_security_analysis: "{{ network_security_analysis | combine({'issues': network_security_analysis.issues + ['No network policies detected in cluster']}) }}"
      when: network_policies_list_items | length == 0

    - name: Update security analysis with network security
      set_fact:
        security_analysis: "{{ security_analysis | default({}) | combine({'network_security': network_security_analysis}) }}"

    - name: Set fact for network security analysis status
      set_fact:
        analysis_status:
          network_security_analysis: true

    - name: Display network security analysis status
      debug:
        msg: "Network security analysis completed successfully"

  rescue:
    - name: Handle network security analysis failure
      debug:
        msg: "Failed to analyze network security: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for network security analysis status
      set_fact:
        analysis_status:
          network_security_analysis: false

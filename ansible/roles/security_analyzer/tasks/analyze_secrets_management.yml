---
- name: Analyze secrets management
  block:
    - name: Set default secrets management analysis
      set_fact:
        secrets_management_analysis:
          total_secrets: 0
          secrets_by_namespace: {}
          secrets_by_type: {}
          issues: ["Secrets management analysis limited - detailed secrets data not collected"]

    - name: Load secrets data
      include_vars:
        file: "{{ data_output_path }}/security_configs.json"
        name: security_data
      when: 
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true

    - name: Set default secrets data if not available
      set_fact:
        security_data:
          secrets_json: '{"items": []}'
      when: (security_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool)

    - name: Initialize secrets_list_raw
      set_fact:
        secrets_list_raw: {"items": []}

    - name: Parse secrets data
      set_fact:
        secrets_list_raw: "{{ security_data.secrets_json | default('{\"items\": []}') | from_json }}"
      when: security_data is defined

    - name: Ensure secrets_list is a dict with items
      set_fact:
        secrets_list: "{{ secrets_list_raw | default({'items': []}) }}"

    - name: Extract secrets_list_items
      set_fact:
        secrets_list_items: "{{ (secrets_list.get('items', [])) if (secrets_list is mapping) else [] }}"

    - name: Filter secrets_list_items to only mappings
      set_fact:
        secrets_list_items_filtered: "{{ secrets_list_items | select('mapping') | list }}"

    - name: Analyze secrets
      set_fact:
        secrets_management_analysis:
          total_secrets: "{{ secrets_list_items_filtered | length }}"
          secrets_by_namespace: "{{ secrets_list_items_filtered | groupby('metadata.namespace') | map('first') | list }}"
          secrets_by_type: "{{ secrets_list_items_filtered | groupby('type') | map('first') | list }}"
          issues: []

    - name: Check for secrets without proper labels
      set_fact:
        secrets_management_analysis: "{{ secrets_management_analysis | combine({'issues': secrets_management_analysis.issues + ['Some secrets may not have proper labels for management']}) }}"
      when: secrets_list_items_filtered | selectattr('metadata.labels', 'undefined') | list | length > 0

    - name: Update security analysis with secrets management
      set_fact:
        security_analysis: "{{ security_analysis | default({}) | combine({'secrets_management': secrets_management_analysis}) }}"

    - name: Set fact for secrets management analysis status
      set_fact:
        analysis_status:
          secrets_management_analysis: true

    - name: Display secrets management analysis status
      debug:
        msg: "Secrets management analysis completed successfully"

  rescue:
    - name: Handle secrets management analysis failure
      debug:
        msg: "Failed to analyze secrets management: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for secrets management analysis status
      set_fact:
        analysis_status:
          secrets_management_analysis: false

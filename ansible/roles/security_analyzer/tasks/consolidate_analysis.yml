---
- name: Consolidate security analysis
  block:
    - name: Initialize security_analysis if not exists
      set_fact:
        security_analysis: {}
      when: security_analysis is not defined

    - name: Ensure security_analysis is defined
      set_fact:
        security_analysis: "{{ security_analysis | default({}) }}"

    - name: Ensure all required sections exist in security_analysis
      set_fact:
        security_analysis: "{{ security_analysis | combine({'rbac_analysis': security_analysis.get('rbac_analysis', {'cluster_roles': {}, 'cluster_role_bindings': {}, 'service_accounts': {}, 'excessive_permissions': [], 'privileged_accounts': [], 'issues': []})}, recursive=True) | combine({'pod_security': security_analysis.get('pod_security', {'pod_security_issues': []})}, recursive=True) | combine({'network_security': security_analysis.get('network_security', {})}, recursive=True) | combine({'secrets_management': security_analysis.get('secrets_management', {})}, recursive=True) | combine({'compliance': security_analysis.get('compliance', {})}, recursive=True) }}"

    - name: Create security analysis output directory
      file:
        path: "{{ security_output_dir }}"
        state: directory
        mode: '0755'

    - name: Initialize security score
      set_fact:
        security_score: 100
        security_analysis_status: "{{ security_analysis_status | default({}) }}"

    - name: Calculate overall security score
      block:
        - name: Deduct points for RBAC issues
          set_fact:
            security_score: "{{ security_score - ((security_analysis.get('rbac_analysis', {}).get('issues', []) | length) * 10) }}"
          when: 
            - security_analysis_status is defined
            - security_analysis_status.get('rbac_analysis', false) | bool

        - name: Deduct points for pod security issues
          set_fact:
            security_score: "{{ security_score - ((security_analysis.get('pod_security', {}).get('pod_security_issues', []) | length) * 15) }}"
          when: 
            - security_analysis_status is defined
            - security_analysis_status.get('pod_security', false) | bool

        - name: Ensure score doesn't go below 0
          set_fact:
            security_score: "{{ [(security_score | int), 0] | max }}"

    - name: Update security analysis with overall score
      set_fact:
        security_analysis: "{{ security_analysis | combine({'overall_security_score': security_score, 'analysis_timestamp': ansible_date_time.iso8601, 'cluster_url': openshift_cluster_url}, recursive=True) }}"

    - name: Save security analysis results
      copy:
        content: "{{ security_analysis | to_nice_json }}"
        dest: "{{ security_output_dir }}/security_analysis.json"
        mode: '0644'

    - name: Create security analysis report
      template:
        src: security_analysis_report.j2
        dest: "{{ security_output_dir }}/security_analysis_report.md"
        mode: '0644'
      when: not ansible_check_mode | bool
      ignore_errors: true

    - name: Set fact for security analysis completion
      set_fact:
        security_analysis_completed: true
        security_analysis_path: "{{ security_output_dir }}"

    - name: Display security analysis summary
      debug:
        msg: |
          Security analysis completed!
          
          Analysis Status:
          - RBAC Analysis: {{ 'OK' if (security_analysis_status.get('rbac_analysis', false) | bool) else 'Falhou' }}
          - Network Security: {{ 'OK' if (security_analysis_status.get('network_security_analysis', false) | bool) else 'Falhou' }}
          - Pod Security: {{ 'OK' if (security_analysis_status.get('pod_security', false) | bool) else 'Falhou' }}
          - Secrets Management: {{ 'OK' if (security_analysis_status.get('secrets_management_analysis', false) | bool) else 'Falhou' }}
          - Compliance Analysis: {{ 'OK' if (security_analysis_status.get('compliance_analysis', false) | bool) else 'Falhou' }}
          
          Overall Security Score: {{ security_score }}/100
          Analysis saved to: {{ security_output_dir }}

  rescue:
    - name: Handle security analysis consolidation failure
      debug:
        msg: "Failed to consolidate security analysis: {{ ansible_failed_result.msg }}"
      
    - name: Ensure all required sections exist in security_analysis even on failure
      set_fact:
        security_analysis: "{{ security_analysis | default({}) | combine({'rbac_analysis': security_analysis.get('rbac_analysis', {'cluster_roles': {}, 'cluster_role_bindings': {}, 'service_accounts': {}, 'excessive_permissions': [], 'privileged_accounts': [], 'issues': []})}, recursive=True) | combine({'pod_security': security_analysis.get('pod_security', {'pod_security_issues': []})}, recursive=True) | combine({'network_security': security_analysis.get('network_security', {})}, recursive=True) | combine({'secrets_management': security_analysis.get('secrets_management', {})}, recursive=True) | combine({'compliance': security_analysis.get('compliance', {})}, recursive=True) | combine({'overall_security_score': security_analysis.get('overall_security_score', 0), 'analysis_timestamp': security_analysis.get('analysis_timestamp', ansible_date_time.iso8601), 'cluster_url': security_analysis.get('cluster_url', openshift_cluster_url)}, recursive=True) }}"
      
    - name: Set fact for security analysis completion
      set_fact:
        security_analysis_completed: false

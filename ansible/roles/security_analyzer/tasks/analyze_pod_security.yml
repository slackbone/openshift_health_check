---
- name: Analyze pod security
  block:
    - name: Load pods and security data from host
      slurp:
        src: "{{ data_output_path }}/pods.json"
      register: pods_sec_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Load security configs from host
      slurp:
        src: "{{ data_output_path }}/security_configs.json"
      register: security_pod_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Set pods_data from slurped content
      set_fact:
        pods_data: "{{ (pods_sec_slurp.content | b64decode) | from_json }}"
      when:
        - pods_sec_slurp is defined
        - pods_sec_slurp.content is defined
        - (pods_sec_slurp.content | length) > 0

    - name: Set security_data from slurped content (pod security)
      set_fact:
        security_data: "{{ (security_pod_slurp.content | b64decode) | from_json }}"
      when:
        - security_pod_slurp is defined
        - security_pod_slurp.content is defined
        - (security_pod_slurp.content | length) > 0

    - name: Set default data if not available
      set_fact:
        pods_data:
          pods_json: '{"items": []}'
        security_data:
          securitycontextconstraints: '{"items": []}'
          podsecuritypolicies_json: '{"items": []}'
      when: (pods_data is not defined) or (security_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool) or (pods_sec_slurp is not defined) or ((pods_sec_slurp.content | default('')) | length == 0) or (security_pod_slurp is not defined) or ((security_pod_slurp.content | default('')) | length == 0)

    - name: Parse data
      set_fact:
        pods_list_raw: "{{ pods_data.pods_json | default('{\"items\": []}') | from_json }}"
        scc_list_raw: "{{ security_data.securitycontextconstraints | default('{\"items\": []}') | from_json }}"
        psp_list_raw: "{{ security_data.podsecuritypolicies_json | default('{\"items\": []}') | from_json }}"
      when: pods_data is defined and security_data is defined

    - name: Ensure security lists are dicts with items
      set_fact:
        pods_list: "{{ pods_list_raw | default({'items': []}) }}"
        scc_list: "{{ scc_list_raw | default({'items': []}) }}"
        psp_list: "{{ psp_list_raw | default({'items': []}) }}"
        pods_list_items: "{{ (pods_list.get('items', [])) if (pods_list is mapping) else [] }}"
        scc_list_items: "{{ (scc_list.get('items', [])) if (scc_list is mapping) else [] }}"
        psp_list_items: "{{ (psp_list.get('items', [])) if (psp_list is mapping) else [] }}"

    - name: Analyze security context constraints
      set_fact:
        scc_analysis:
          total_sccs: "{{ scc_list_items | length }}"
          privileged_sccs: "{{ scc_list_items | selectattr('allowPrivilegedContainer', 'equalto', true) | list | length }}"
          host_network_sccs: "{{ scc_list_items | selectattr('allowHostNetwork', 'equalto', true) | list | length }}"
          host_pid_sccs: "{{ scc_list_items | selectattr('allowHostPID', 'equalto', true) | list | length }}"

    - name: Analyze pod security
      set_fact:
        pod_security_analysis:
          total_pods: "{{ pods_list_items | length }}"
          privileged_containers: "{{ pods_list_items | selectattr('spec.containers', 'defined') | selectattr('spec.containers', 'selectattr', 'securityContext.privileged', 'equalto', true) | list | length }}"
          root_containers: "{{ pods_list_items | selectattr('spec.containers', 'defined') | selectattr('spec.containers', 'selectattr', 'securityContext.runAsUser', 'equalto', 0) | list | length }}"
          host_network_pods: "{{ pods_list_items | selectattr('spec.hostNetwork', 'equalto', true) | list | length }}"
          host_pid_pods: "{{ pods_list_items | selectattr('spec.hostPID', 'equalto', true) | list | length }}"
          host_ipc_pods: "{{ pods_list_items | selectattr('spec.hostIPC', 'equalto', true) | list | length }}"

    - name: Initialize pod security issues
      set_fact:
        pod_security_issues: []
        privileged_containers_int: 0
        root_containers_int: 0
        host_network_pods_int: 0

    - name: Convert pod security values to integers
      set_fact:
        privileged_containers_int: "{{ (pod_security_analysis.privileged_containers | default(0) | int) if (pod_security_analysis is defined and pod_security_analysis.privileged_containers is defined) else privileged_containers_int }}"
        root_containers_int: "{{ (pod_security_analysis.root_containers | default(0) | int) if (pod_security_analysis is defined and pod_security_analysis.root_containers is defined) else root_containers_int }}"
        host_network_pods_int: "{{ (pod_security_analysis.host_network_pods | default(0) | int) if (pod_security_analysis is defined and pod_security_analysis.host_network_pods is defined) else host_network_pods_int }}"

    - name: Check pod security issues
      block:
        - name: Check for privileged containers
          set_fact:
            pod_security_issues: "{{ pod_security_issues + ['Privileged containers detected: ' + (privileged_containers_int | string)] }}"
          when: (privileged_containers_int | int) > (max_privileged_containers | default(0) | int)

        - name: Check for root containers
          set_fact:
            pod_security_issues: "{{ pod_security_issues + ['Root containers detected: ' + (root_containers_int | string)] }}"
          when: (root_containers_int | int) > (max_root_containers | default(0) | int)

        - name: Check for host network pods
          set_fact:
            pod_security_issues: "{{ pod_security_issues + ['Host network pods detected: ' + (host_network_pods_int | string)] }}"
          when: (host_network_pods_int | int) > (max_host_network_pods | default(0) | int)

    - name: Update security analysis with pod security
      set_fact:
        security_analysis:
          pod_security:
            security_context_constraints: "{{ scc_analysis }}"
            pod_security_policies: "{{ psp_list_items | length }}"
            privileged_containers: "{{ pod_security_analysis.privileged_containers }}"
            root_containers: "{{ pod_security_analysis.root_containers }}"
            host_network_pods: "{{ pod_security_analysis.host_network_pods }}"
            host_pid_pods: "{{ pod_security_analysis.host_pid_pods }}"
            host_ipc_pods: "{{ pod_security_analysis.host_ipc_pods }}"
            pod_security_issues: "{{ pod_security_issues }}"

    - name: Set fact for pod security analysis status
      set_fact:
        security_analysis_status:
          pod_security: true

    - name: Display pod security analysis status
      debug:
        msg: "Pod security analysis completed successfully"

  rescue:
    - name: Handle pod security analysis failure
      debug:
        msg: "Failed to analyze pod security: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for pod security analysis status
      set_fact:
        security_analysis_status:
          pod_security: false

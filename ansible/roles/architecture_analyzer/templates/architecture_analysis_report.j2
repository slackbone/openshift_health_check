# Verificação de Saúde OpenShift - Relatório de Análise de Arquitetura

{% set cluster_overview_default = {'cluster_version': 'Unknown', 'total_nodes': 0, 'master_nodes': 0, 'worker_nodes': 0, 'infrastructure_nodes': 0, 'cluster_health': 'Unknown', 'issues': [], 'total_namespaces': 0} %}
{% if architecture_analysis is defined and architecture_analysis.get('cluster_overview') is defined %}
{% set cluster_overview = architecture_analysis.get('cluster_overview') %}
{% else %}
{% set cluster_overview = cluster_overview_default %}
{% endif %}

## Resumo da Análise

**Timestamp da Análise:** {{ ansible_date_time.iso8601 }}  
**URL do Cluster:** {{ openshift_cluster_url }}  
**Host de Análise:** {{ inventory_hostname }}  

## Status da Análise

| Componente | Status |
|------------|--------|
| Visão Geral do Cluster | {{ 'Sucesso' if analysis_status.cluster_overview else 'Falhou' }} |
| Análise de Nós | {{ 'Sucesso' if analysis_status.node_analysis else 'Falhou' }} |
| Análise de Rede | {{ 'Sucesso' if analysis_status.network_analysis else 'Falhou' }} |
| Análise de Armazenamento | {{ 'Sucesso' if analysis_status.storage_analysis else 'Falhou' }} |
| Análise de Operadores | {{ 'Sucesso' if analysis_status.operator_analysis else 'Falhou' }} |
| Distribuição de Recursos | {{ 'Sucesso' if analysis_status.resource_distribution else 'Falhou' }} |

## Visão Geral do Cluster
{% if cluster_overview %}
- **Versão do Cluster:** {{ cluster_overview.get('cluster_version', 'Unknown') }}
- **Total de Nós:** {{ cluster_overview.get('total_nodes', 0) }}
- **Nós Master:** {{ cluster_overview.get('master_nodes', 0) }}
- **Nós Worker:** {{ cluster_overview.get('worker_nodes', 0) }}
- **Nós de Infraestrutura:** {{ cluster_overview.get('infrastructure_nodes', 0) }}
- **Total de Namespaces:** {{ cluster_overview.get('total_namespaces', 0) }}
- **Saúde do Cluster:** {{ cluster_overview.get('cluster_health', 'Unknown') }}

{% if cluster_overview.get('issues', []) | length > 0 %}
### Problemas do Cluster
{% for issue in cluster_overview.get('issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise da visão geral do cluster falhou ou não disponível
{% endif %}

## Arquitetura de Nós

{% set node_analysis = architecture_analysis.get('node_analysis', {}) if architecture_analysis is defined else {} %}
{% if analysis_status.node_analysis and node_analysis %}
- **Total de Nós:** {{ node_analysis.get('node_distribution', {}).get('total_nodes', 0) }}
- **Nós Master:** {{ node_analysis.get('node_distribution', {}).get('master_nodes', 0) }}
- **Nós Worker:** {{ node_analysis.get('node_distribution', {}).get('worker_nodes', 0) }}
- **Nós de Infraestrutura:** {{ node_analysis.get('node_distribution', {}).get('infrastructure_nodes', 0) }}

### Utilização de Recursos
- **Total de Cores CPU:** {{ node_analysis.get('resource_utilization', {}).get('total_cpu_cores', 0) }}
- **Total de Memória:** {{ node_analysis.get('resource_utilization', {}).get('total_memory', 0) }}
- **CPU Alocável:** {{ node_analysis.get('resource_utilization', {}).get('allocatable_cpu', 0) }}
- **Memória Alocável:** {{ node_analysis.get('resource_utilization', {}).get('allocatable_memory', 0) }}

{% if node_analysis.get('issues', []) | length > 0 %}
### Problemas dos Nós
{% for issue in node_analysis.get('issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise da arquitetura de nós falhou
{% endif %}

## Arquitetura de Rede

{% set network_analysis = architecture_analysis.get('network_analysis', {}) if architecture_analysis is defined else {} %}
{% if analysis_status.network_analysis and network_analysis %}
- **Políticas de Rede:** {{ network_analysis.get('network_policies', {}).get('total_policies', 0) }}
- **Namespaces com Políticas:** {{ network_analysis.get('network_policies', {}).get('namespaces_with_policies', 0) }}
- **Total de Rotas:** {{ network_analysis.get('ingress_controllers', {}).get('total_routes', 0) }}
- **Total de Ingresses:** {{ network_analysis.get('ingress_controllers', {}).get('total_ingresses', 0) }}
- **Serviços LoadBalancer:** {{ network_analysis.get('load_balancers', {}).get('services_with_load_balancer', 0) }}
- **Serviços NodePort:** {{ network_analysis.get('load_balancers', {}).get('services_with_node_port', 0) }}

{% if network_analysis.get('issues', []) | length > 0 %}
### Problemas de Rede
{% for issue in network_analysis.get('issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise da arquitetura de rede falhou
{% endif %}

## Arquitetura de Armazenamento

{% set storage_analysis = architecture_analysis.get('storage_analysis', {}) if architecture_analysis is defined else {} %}
{% if analysis_status.storage_analysis and storage_analysis %}
- **Volumes Persistentes:** {{ storage_analysis.get('persistent_volumes', {}).get('total_pvs', 0) }}
- **PVs Vinculados:** {{ storage_analysis.get('persistent_volumes', {}).get('bound_pvs', 0) }}
- **PVs Disponíveis:** {{ storage_analysis.get('persistent_volumes', {}).get('available_pvs', 0) }}
- **Classes de Armazenamento:** {{ storage_analysis.get('storage_classes', {}).get('total_storage_classes', 0) }}
- **Classe de Armazenamento Padrão:** {{ storage_analysis.get('storage_classes', {}).get('default_storage_class', 'Unknown') }}

{% if storage_analysis.get('issues', []) | length > 0 %}
### Problemas de Armazenamento
{% for issue in storage_analysis.get('issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise da arquitetura de armazenamento falhou
{% endif %}

## Saúde dos Operadores

{% set operator_analysis = architecture_analysis.get('operator_analysis', {}) if architecture_analysis is defined else {} %}
{% if analysis_status.operator_analysis and operator_analysis %}
- **Versões de Serviço do Cluster:** {{ operator_analysis.get('operator_health', {}).get('total_csvs', 0) }}
- **Assinaturas:** {{ operator_analysis.get('operator_health', {}).get('total_subscriptions', 0) }}
- **Planos de Instalação:** {{ operator_analysis.get('operator_health', {}).get('total_install_plans', 0) }}
- **Grupos de Operadores:** {{ operator_analysis.get('operator_health', {}).get('total_operator_groups', 0) }}

{% if operator_analysis.get('operator_issues', []) | length > 0 %}
### Problemas dos Operadores
{% for issue in operator_analysis.get('operator_issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise da saúde dos operadores falhou
{% endif %}

## Distribuição de Recursos

{% set resource_distribution = architecture_analysis.get('resource_distribution', {}) if architecture_analysis is defined else {} %}
{% if analysis_status.resource_distribution and resource_distribution %}
- **Total de Namespaces:** {{ resource_distribution.get('namespace_distribution', {}).get('total_namespaces', 0) }}
- **Namespaces do Sistema:** {{ resource_distribution.get('namespace_distribution', {}).get('system_namespaces', 0) }}
- **Namespaces de Usuário:** {{ resource_distribution.get('namespace_distribution', {}).get('user_namespaces', 0) }}
- **Namespaces com Quotas:** {{ resource_distribution.get('namespace_distribution', {}).get('namespaces_with_quotas', 0) }}
- **Namespaces com Limites:** {{ resource_distribution.get('namespace_distribution', {}).get('namespaces_with_limits', 0) }}
- **Total de Pods:** {{ resource_distribution.get('pod_distribution', {}).get('total_pods', 0) }}
- **Pods em Execução:** {{ resource_distribution.get('pod_distribution', {}).get('running_pods', 0) }}
- **Pods Pendentes:** {{ resource_distribution.get('pod_distribution', {}).get('pending_pods', 0) }}
- **Pods Falharam:** {{ resource_distribution.get('pod_distribution', {}).get('failed_pods', 0) }}

{% if resource_distribution.get('issues', []) | length > 0 %}
### Problemas de Distribuição de Recursos
{% for issue in resource_distribution.get('issues', []) %}
- AVISO: {{ issue }}
{% endfor %}
{% endif %}
{% else %}
ERRO: Análise da distribuição de recursos falhou
{% endif %}

## Recomendações

### Alta Prioridade
{% if cluster_overview.get('issues', []) | length > 0 %}
- Resolver problemas de saúde do cluster identificados na visão geral
{% endif %}
{% if node_analysis.get('issues', []) | length > 0 %}
- Resolver problemas de saúde dos nós
{% endif %}
{% if (resource_distribution.get('pod_distribution', {}).get('failed_pods', 0) | int) > 0 %}
- Investigar e resolver pods que falharam
{% endif %}

### Média Prioridade
{% if network_analysis.get('network_policies', {}).get('total_policies', 0) == 0 %}
- Implementar políticas de rede para melhor segurança
{% endif %}
{% if storage_analysis.get('storage_classes', {}).get('default_storage_class', 'Unknown') == "Unknown" %}
- Configurar classe de armazenamento padrão
{% endif %}
{% if (resource_distribution.get('namespace_distribution', {}).get('namespaces_with_quotas', 0) | int) < ((resource_distribution.get('namespace_distribution', {}).get('total_namespaces', 0) | int) * 0.5) %}
- Implementar quotas de recursos para melhor gerenciamento
{% endif %}

### Baixa Prioridade
{% if (network_analysis.get('load_balancers', {}).get('services_with_load_balancer', 0) | int) > 10 %}
- Revisar uso de serviços LoadBalancer para otimização de custos
{% endif %}
{% if (resource_distribution.get('pod_distribution', {}).get('pending_pods', 0) | int) > 5 %}
- Monitorar pods pendentes e disponibilidade de recursos
{% endif %}

## Estatísticas da Análise

{% set success_count = 0 %}
{% set total_count = 0 %}
{% for key, value in analysis_status.items() %}
{% set total_count = total_count + 1 %}
{% if value %}
{% set success_count = success_count + 1 %}
{% endif %}
{% endfor %}

**Total de Componentes de Análise:** {{ total_count }}  
**Análises Bem-sucedidas:** {{ success_count }}  
**Análises Falharam:** {{ total_count - success_count }}  
**Taxa de Sucesso:** {% if total_count | default(0) > 0 %}{{ ((success_count / total_count) * 100) | round(2) }}%{% else %}N/A{% endif %}  

## Notas

{% if success_count < total_count %}
**AVISO:** Algumas tarefas de análise de arquitetura falharam. A análise pode estar incompleta.
{% else %}
**SUCESSO:** Todas as tarefas de análise de arquitetura foram concluídas com sucesso.
{% endif %}

Este relatório foi gerado automaticamente pelo playbook de Verificação de Saúde OpenShift do Ansible.

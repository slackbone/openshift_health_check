---
- name: Consolidate architecture analysis
  block:
    - name: Initialize architecture_analysis if not exists
      set_fact:
        architecture_analysis: {}
      when: architecture_analysis is not defined

    - name: Ensure architecture_analysis is defined
      set_fact:
        architecture_analysis: "{{ architecture_analysis | default({}) }}"

    - name: Ensure cluster_overview exists in architecture_analysis
      set_fact:
        architecture_analysis: "{{ architecture_analysis | combine({'cluster_overview': (architecture_analysis.get('cluster_overview', {'cluster_version': 'Unknown', 'total_nodes': 0, 'master_nodes': 0, 'worker_nodes': 0, 'infrastructure_nodes': 0, 'cluster_health': 'Unknown', 'issues': [], 'total_namespaces': 0}))}) }}"
      vars:
        cluster_overview_default: {'cluster_version': 'Unknown', 'total_nodes': 0, 'master_nodes': 0, 'worker_nodes': 0, 'infrastructure_nodes': 0, 'cluster_health': 'Unknown', 'issues': [], 'total_namespaces': 0}

    - name: Create architecture analysis output directory
      file:
        path: "{{ architecture_output_dir }}"
        state: directory
        mode: '0755'

    - name: Save architecture analysis results
      copy:
        content: "{{ architecture_analysis | to_nice_json }}"
        dest: "{{ architecture_output_dir }}/architecture_analysis.json"
        mode: '0644'

    - name: Ensure cluster_overview exists before template rendering
      set_fact:
        architecture_analysis: "{{ architecture_analysis | combine({'cluster_overview': architecture_analysis.get('cluster_overview', {'cluster_version': 'Unknown', 'total_nodes': 0, 'master_nodes': 0, 'worker_nodes': 0, 'infrastructure_nodes': 0, 'cluster_health': 'Unknown', 'issues': [], 'total_namespaces': 0})}) }}"

    - name: Create architecture analysis report
      template:
        src: architecture_analysis_report.j2
        dest: "{{ architecture_output_dir }}/architecture_analysis_report.md"
        mode: '0644'
      when: not ansible_check_mode | bool
      ignore_errors: true

    - name: Set fact for architecture analysis completion
      set_fact:
        architecture_analysis_completed: true
        architecture_analysis_path: "{{ architecture_output_dir }}"

    - name: Display architecture analysis summary
      debug:
        msg: |
          Architecture analysis completed!
          
          Analysis Status:
          - Cluster Overview: {{ 'OK' if (analysis_status | default({})).get('cluster_overview', false) else 'Falhou' }}
          - Node Analysis: {{ 'OK' if (analysis_status | default({})).get('node_analysis', false) else 'Falhou' }}
          - Network Analysis: {{ 'OK' if (analysis_status | default({})).get('network_analysis', false) else 'Falhou' }}
          - Storage Analysis: {{ 'OK' if (analysis_status | default({})).get('storage_analysis', false) else 'Falhou' }}
          - Operator Analysis: {{ 'OK' if (analysis_status | default({})).get('operator_analysis', false) else 'Falhou' }}
          - Resource Distribution: {{ 'OK' if (analysis_status | default({})).get('resource_distribution', false) else 'Falhou' }}
          
          Analysis saved to: {{ architecture_output_dir }}

  rescue:
    - name: Handle architecture analysis consolidation failure
      debug:
        msg: "Failed to consolidate architecture analysis: {{ ansible_failed_result.msg }}"
      
    - name: Ensure cluster_overview exists even on failure
      set_fact:
        architecture_analysis: "{{ architecture_analysis | default({}) | combine({'cluster_overview': architecture_analysis.get('cluster_overview', {'cluster_version': 'Unknown', 'total_nodes': 0, 'master_nodes': 0, 'worker_nodes': 0, 'infrastructure_nodes': 0, 'cluster_health': 'Unknown', 'issues': ['Analysis failed'], 'total_namespaces': 0})}) }}"
      
    - name: Set fact for architecture analysis completion
      set_fact:
        architecture_analysis_completed: false

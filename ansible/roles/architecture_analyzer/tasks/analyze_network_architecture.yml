---
- name: Analyze network architecture
  block:
    - name: Load network-related data from host
      slurp:
        src: "{{ data_output_path }}/services.json"
      register: services_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Load security configs for network policies from host
      slurp:
        src: "{{ data_output_path }}/security_configs.json"
      register: security_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Set services_data from slurped content
      set_fact:
        services_data: "{{ (services_slurp.content | b64decode) | from_json }}"
      when:
        - services_slurp is defined
        - services_slurp.content is defined
        - (services_slurp.content | length) > 0

    - name: Set security_data from slurped content
      set_fact:
        security_data: "{{ (security_slurp.content | b64decode) | from_json }}"
      when:
        - security_slurp is defined
        - security_slurp.content is defined
        - (security_slurp.content | length) > 0

    - name: Set default network data if not available
      set_fact:
        services_data:
          services_json: '{"items": []}'
          routes_json: '{"items": []}'
          ingresses_json: '{"items": []}'
          endpoints_json: '{"items": []}'
        security_data:
          networkpolicies_json: '{"items": []}'
      when: (services_data is not defined) or (security_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool) or (services_slurp is not defined) or ((services_slurp.content | default('')) | length == 0) or (security_slurp is not defined) or ((security_slurp.content | default('')) | length == 0)

    - name: Parse network data
      set_fact:
        services_list_raw: "{{ services_data.services_json | default('{\"items\": []}') | from_json }}"
        routes_list_raw: "{{ services_data.routes_json | default('{\"items\": []}') | from_json }}"
        ingresses_list_raw: "{{ services_data.ingresses_json | default('{\"items\": []}') | from_json }}"
        network_policies_list_raw: "{{ security_data.networkpolicies_json | default('{\"items\": []}') | from_json }}"
      when: services_data is defined and security_data is defined

    - name: Ensure network lists are dicts with items
      set_fact:
        services_list: "{{ services_list_raw | default({'items': []}) }}"
        routes_list: "{{ routes_list_raw | default({'items': []}) }}"
        ingresses_list: "{{ ingresses_list_raw | default({'items': []}) }}"
        network_policies_list: "{{ network_policies_list_raw | default({'items': []}) }}"
        services_list_items: "{{ (services_list.get('items', [])) if (services_list is mapping) else [] }}"
        routes_list_items: "{{ (routes_list.get('items', [])) if (routes_list is mapping) else [] }}"
        ingresses_list_items: "{{ (ingresses_list.get('items', [])) if (ingresses_list is mapping) else [] }}"
        network_policies_list_items: "{{ (network_policies_list.get('items', [])) if (network_policies_list is mapping) else [] }}"

    - name: Analyze network policies
      set_fact:
        network_policies_analysis:
          total_policies: "{{ network_policies_list_items | length }}"
          policies_by_namespace: "{{ network_policies_list_items | groupby('metadata.namespace') | map('first') | list }}"
          namespaces_with_policies: "{{ network_policies_list_items | map(attribute='metadata.namespace') | unique | list | length }}"

    - name: Analyze ingress controllers
      set_fact:
        ingress_controllers_analysis:
          total_routes: "{{ routes_list_items | length }}"
          total_ingresses: "{{ ingresses_list_items | length }}"
          routes_by_namespace: "{{ routes_list_items | groupby('metadata.namespace') | map('first') | list }}"
          ingresses_by_namespace: "{{ ingresses_list_items | groupby('metadata.namespace') | map('first') | list }}"

    - name: Analyze load balancers
      set_fact:
        load_balancers_analysis:
          services_with_external_ips: "{{ services_list_items | selectattr('spec.externalIPs', 'defined') | list | length }}"
          services_with_load_balancer: "{{ services_list_items | selectattr('spec.type', 'equalto', 'LoadBalancer') | list | length }}"
          services_with_node_port: "{{ services_list_items | selectattr('spec.type', 'equalto', 'NodePort') | list | length }}"

    - name: Analyze DNS configuration
      set_fact:
        dns_analysis:
          total_services: "{{ services_list_items | length }}"
          services_with_cluster_ip: "{{ services_list_items | selectattr('spec.clusterIP', 'defined') | list | length }}"
          headless_services: "{{ services_list_items | selectattr('spec.clusterIP', 'equalto', 'None') | list | length }}"

    - name: Initialize network issues
      set_fact:
        network_issues: []

    - name: Check network architecture issues
      block:
        - name: Check for namespaces without network policies
          set_fact:
            network_issues: "{{ network_issues + ['Some namespaces may not have network policies configured'] }}"
          when: network_policies_analysis.total_policies == 0

        - name: Check for excessive load balancer services
          set_fact:
            network_issues: "{{ network_issues + ['High number of LoadBalancer services may impact costs'] }}"
          when: (load_balancers_analysis.services_with_load_balancer | int) > 10

    - name: Update architecture analysis with network analysis
      set_fact:
        architecture_analysis:
          network_analysis:
            network_policies: "{{ network_policies_analysis }}"
            ingress_controllers: "{{ ingress_controllers_analysis }}"
            load_balancers: "{{ load_balancers_analysis }}"
            dns_configuration: "{{ dns_analysis }}"
            issues: "{{ network_issues }}"

    - name: Set fact for network analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'network_analysis': true}) }}"

    - name: Display network analysis status
      debug:
        msg: "Network architecture analysis completed successfully"

  rescue:
    - name: Handle network analysis failure
      debug:
        msg: "Failed to analyze network architecture: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for network analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'network_analysis': false}) }}"

---
- name: Analyze resource distribution
  block:
    - name: Load namespaces data from host
      slurp:
        src: "{{ data_output_path }}/namespaces.json"
      register: namespaces_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Load pods data from host
      slurp:
        src: "{{ data_output_path }}/pods.json"
      register: pods_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Set namespaces_data from slurped content
      block:
        - name: Parse namespaces JSON
          set_fact:
            namespaces_data: "{{ (namespaces_slurp.content | b64decode) | from_json }}"
      rescue:
        - name: Set default namespaces data on parse error
          set_fact:
            namespaces_data:
              namespaces_json: '{"items": []}'
              resource_quotas: '{"items": []}'
              limit_ranges: '{"items": []}'
      when:
        - namespaces_slurp is defined
        - namespaces_slurp.content is defined
        - (namespaces_slurp.content | length) > 0

    - name: Set pods_data from slurped content
      block:
        - name: Parse pods JSON
          set_fact:
            pods_data: "{{ (pods_slurp.content | b64decode) | from_json }}"
      rescue:
        - name: Set default pods data on parse error (e.g. control chars in JSON)
          set_fact:
            pods_data:
              pods_json: '{"items": []}'
      when:
        - pods_slurp is defined
        - pods_slurp.content is defined
        - (pods_slurp.content | length) > 0

    - name: Set default data if not available
      set_fact:
        namespaces_data:
          namespaces_json: '{"items": []}'
          resource_quotas: '{"items": []}'
          limit_ranges: '{"items": []}'
        pods_data:
          pods_json: '{"items": []}'
      when: (namespaces_data is not defined) or (pods_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool) or (namespaces_slurp is not defined) or ((namespaces_slurp.content | default('')) | length == 0) or (pods_slurp is not defined) or ((pods_slurp.content | default('')) | length == 0)

    # Aceitar *_json j√° como dict (slurp+from_json ou novo formato) ou como string (from_json)
    - name: Parse data
      set_fact:
        namespaces_list_raw: "{{ (namespaces_data.namespaces_json if (namespaces_data.namespaces_json is defined and namespaces_data.namespaces_json is mapping) else (namespaces_data.namespaces_json | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
        resource_quotas_list_raw: "{{ (namespaces_data.resource_quotas if (namespaces_data.resource_quotas is defined and namespaces_data.resource_quotas is mapping) else (namespaces_data.resource_quotas | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
        limit_ranges_list_raw: "{{ (namespaces_data.limit_ranges if (namespaces_data.limit_ranges is defined and namespaces_data.limit_ranges is mapping) else (namespaces_data.limit_ranges | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
        pods_list_raw: "{{ (pods_data.pods_json if (pods_data.pods_json is defined and pods_data.pods_json is mapping) else (pods_data.pods_json | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
      when: namespaces_data is defined and pods_data is defined

    - name: Ensure resource lists are dicts with items
      set_fact:
        namespaces_list: "{{ namespaces_list_raw | default({'items': []}) }}"
        resource_quotas_list: "{{ resource_quotas_list_raw | default({'items': []}) }}"
        limit_ranges_list: "{{ limit_ranges_list_raw | default({'items': []}) }}"
        pods_list: "{{ pods_list_raw | default({'items': []}) }}"
        namespaces_list_items: "{{ (namespaces_list.get('items', [])) if (namespaces_list is mapping) else [] }}"
        resource_quotas_list_items: "{{ (resource_quotas_list.get('items', [])) if (resource_quotas_list is mapping) else [] }}"
        limit_ranges_list_items: "{{ (limit_ranges_list.get('items', [])) if (limit_ranges_list is mapping) else [] }}"
        pods_list_items: "{{ (pods_list.get('items', [])) if (pods_list is mapping) else [] }}"

    - name: Analyze namespace distribution
      set_fact:
        namespace_distribution:
          total_namespaces: "{{ namespaces_list_items | length }}"
          system_namespaces: "{{ namespaces_list_items | selectattr('metadata.name', 'match', '^(kube-|openshift-|default)') | list | length }}"
          user_namespaces: "{{ namespaces_list_items | rejectattr('metadata.name', 'match', '^(kube-|openshift-|default)') | list | length }}"
          namespaces_with_quotas: "{{ resource_quotas_list_items | map(attribute='metadata.namespace') | unique | list | length }}"
          namespaces_with_limits: "{{ limit_ranges_list_items | map(attribute='metadata.namespace') | unique | list | length }}"

    - name: Analyze resource quotas
      set_fact:
        resource_quotas_analysis:
          total_quotas: "{{ resource_quotas_list_items | length }}"
          quotas_by_namespace: "{{ resource_quotas_list_items | groupby('metadata.namespace') | map('first') | list }}"
          quota_types: "{{ resource_quotas_list_items | map(attribute='spec.scopes') | unique | list }}"

    - name: Analyze limit ranges
      set_fact:
        limit_ranges_analysis:
          total_limit_ranges: "{{ limit_ranges_list_items | length }}"
          limit_ranges_by_namespace: "{{ limit_ranges_list_items | groupby('metadata.namespace') | map('first') | list }}"
          limit_types: "{{ limit_ranges_list_items | map(attribute='spec.limits') | unique | list }}"

    - name: Analyze pod distribution
      set_fact:
        pod_distribution:
          total_pods: "{{ pods_list_items | length }}"
          pods_by_namespace: "{{ pods_list_items | groupby('metadata.namespace') | map('first') | list }}"
          running_pods: "{{ pods_list_items | selectattr('status.phase', 'equalto', 'Running') | list | length }}"
          pending_pods: "{{ pods_list_items | selectattr('status.phase', 'equalto', 'Pending') | list | length }}"
          failed_pods: "{{ pods_list_items | selectattr('status.phase', 'equalto', 'Failed') | list | length }}"

    - name: Initialize resource distribution issues
      set_fact:
        resource_distribution_issues: []

    - name: Check resource distribution issues
      block:
        - name: Check for namespaces without resource quotas
          set_fact:
            resource_distribution_issues: "{{ resource_distribution_issues + ['Some namespaces may not have resource quotas configured'] }}"
          when: (namespace_distribution.namespaces_with_quotas | int) < ((namespace_distribution.total_namespaces | int) * 0.5)

        - name: Check for namespaces without limit ranges
          set_fact:
            resource_distribution_issues: "{{ resource_distribution_issues + ['Some namespaces may not have limit ranges configured'] }}"
          when: (namespace_distribution.namespaces_with_limits | int) < ((namespace_distribution.total_namespaces | int) * 0.5)

        - name: Check for failed pods
          set_fact:
            resource_distribution_issues: "{{ resource_distribution_issues + ['Some pods are in failed state'] }}"
          when: 
            - pod_distribution is defined
            - pod_distribution.failed_pods is defined
            - (pod_distribution.failed_pods | int) > 0

        - name: Check for pending pods
          set_fact:
            resource_distribution_issues: "{{ resource_distribution_issues + ['Some pods are in pending state'] }}"
          when: 
            - pod_distribution is defined
            - pod_distribution.pending_pods is defined
            - (pod_distribution.pending_pods | int) > 5

    - name: Update architecture analysis with resource distribution
      set_fact:
        architecture_analysis:
          resource_distribution:
            namespace_distribution: "{{ namespace_distribution }}"
            resource_quotas: "{{ resource_quotas_analysis }}"
            limit_ranges: "{{ limit_ranges_analysis }}"
            pod_distribution: "{{ pod_distribution }}"
            issues: "{{ resource_distribution_issues }}"

    - name: Set fact for resource distribution analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'resource_distribution': true}) }}"

    - name: Display resource distribution analysis status
      debug:
        msg: "Resource distribution analysis completed successfully"

  rescue:
    - name: Handle resource distribution analysis failure
      debug:
        msg: "Failed to analyze resource distribution: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for resource distribution analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'resource_distribution': false}) }}"

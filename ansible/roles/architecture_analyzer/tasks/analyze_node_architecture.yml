---
- name: Analyze node architecture
  block:
    - name: Load nodes data from host (controller or remote)
      slurp:
        src: "{{ data_output_path }}/nodes.json"
      register: nodes_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Set nodes_data from slurped content
      block:
        - name: Parse nodes JSON
          set_fact:
            nodes_data: "{{ (nodes_slurp.content | b64decode) | from_json }}"
      rescue:
        - name: Set default nodes data on parse error
          set_fact:
            nodes_data:
              nodes_json: '{"items": []}'
              nodes_describe: "No nodes data available"
              nodes_labels: "No nodes labels available"
      when:
        - nodes_slurp is defined
        - nodes_slurp.content is defined
        - (nodes_slurp.content | length) > 0

    - name: Set default nodes data if not available
      set_fact:
        nodes_data:
          nodes_json: '{"items": []}'
          nodes_describe: "No nodes data available"
          nodes_labels: "No nodes labels available"
      when: (nodes_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool) or (nodes_slurp is not defined) or ((nodes_slurp.content | default('')) | length == 0)

    # nodes_json pode ser dict (novo nodes.json com to_nice_json) ou string (formato antigo)
    - name: Parse nodes JSON
      set_fact:
        nodes_list_raw: "{{ (nodes_data.nodes_json if (nodes_data.nodes_json is defined and nodes_data.nodes_json is mapping) else (nodes_data.nodes_json | default('{\"items\": []}') | from_json)) | default({'items': []}) }}"
      when: nodes_data is defined

    - name: Set default nodes list
      set_fact:
        nodes_list_raw:
          items: []
      when: nodes_data is not defined

    - name: Ensure nodes_list is a dict with items
      set_fact:
        nodes_list: "{{ nodes_list_raw | default({'items': []}) }}"
        nodes_list_items: "{{ (nodes_list.get('items', [])) if (nodes_list is mapping) else [] }}"

    - name: Analyze node distribution
      set_fact:
        node_distribution:
          total_nodes: "{{ nodes_list_items | length }}"
          master_nodes: "{{ nodes_list_items | selectattr('metadata.labels', 'defined') | selectattr('metadata.labels.node-role.kubernetes.io/master', 'defined') | list | length }}"
          worker_nodes: "{{ nodes_list_items | selectattr('metadata.labels', 'defined') | selectattr('metadata.labels.node-role.kubernetes.io/worker', 'defined') | list | length }}"
          infrastructure_nodes: "{{ nodes_list_items | selectattr('metadata.labels', 'defined') | selectattr('metadata.labels.node-role.kubernetes.io/infra', 'defined') | list | length }}"

    - name: Initialize node health issues
      set_fact:
        node_health_issues: []

    - name: Check node conditions
      set_fact:
        node_health_issues: "{{ node_health_issues + ['Node ' + item.metadata.name + ' has issues: ' + (item.status.conditions | selectattr('status', 'equalto', 'False') | map(attribute='type') | list | join(', '))] }}"
      loop: "{{ nodes_list_items | default([]) | list }}"
      when: 
        - nodes_list_items is defined
        - nodes_list_items is iterable
        - nodes_list_items is not string
        - item.status.conditions is defined
        - (item.status.conditions | selectattr('status', 'equalto', 'False') | list | length > 0)

    - name: Analyze resource utilization
      set_fact:
        resource_utilization:
          total_cpu_cores: "{{ nodes_list_items | sum(attribute='status.capacity.cpu') | int }}"
          total_memory: "{{ nodes_list_items | sum(attribute='status.capacity.memory') | int }}"
          allocatable_cpu: "{{ nodes_list_items | sum(attribute='status.allocatable.cpu') | int }}"
          allocatable_memory: "{{ nodes_list_items | sum(attribute='status.allocatable.memory') | int }}"

    - name: Update architecture analysis with node analysis
      set_fact:
        architecture_analysis: "{{ architecture_analysis | default({}) | combine({'node_analysis': {'node_distribution': node_distribution | default({}), 'node_health': node_health_issues | default([]), 'resource_utilization': resource_utilization | default({}), 'node_labels': nodes_data.nodes_labels | default('No nodes labels available'), 'issues': node_health_issues | default([])}}) }}"

    - name: Set fact for node analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'node_analysis': true}) }}"

    - name: Display node analysis status
      debug:
        msg: "Node architecture analysis completed successfully"

  rescue:
    - name: Handle node analysis failure
      debug:
        msg: "Failed to analyze node architecture: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for node analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'node_analysis': false}) }}"

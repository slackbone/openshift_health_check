---
- name: Analyze operator health
  block:
    - name: Load operators data
      include_vars:
        file: "{{ data_output_path }}/raw_data/operators.json"
        name: operators_data
      when: 
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true

    - name: Set default operators data if not available
      set_fact:
        operators_data:
          clusterserviceversions_json: '{"items": []}'
          subscriptions_json: '{"items": []}'
          installplans_json: '{"items": []}'
          operatorgroups_json: '{"items": []}'
      when: (operators_data is not defined) or (not data_collection_completed | bool) or (ansible_check_mode | bool)

    - name: Parse operators data
      set_fact:
        csv_list_raw: "{{ operators_data.clusterserviceversions_json | default('{\"items\": []}') | from_json }}"
        subscriptions_list_raw: "{{ operators_data.subscriptions_json | default('{\"items\": []}') | from_json }}"
        installplans_list_raw: "{{ operators_data.installplans_json | default('{\"items\": []}') | from_json }}"
        operatorgroups_list_raw: "{{ operators_data.operatorgroups_json | default('{\"items\": []}') | from_json }}"
      when: operators_data is defined

    - name: Ensure operator lists are dicts with items
      set_fact:
        csv_list: "{{ csv_list_raw | default({'items': []}) }}"
        subscriptions_list: "{{ subscriptions_list_raw | default({'items': []}) }}"
        installplans_list: "{{ installplans_list_raw | default({'items': []}) }}"
        operatorgroups_list: "{{ operatorgroups_list_raw | default({'items': []}) }}"
        csv_list_items: "{{ (csv_list.get('items', [])) if (csv_list is mapping) else [] }}"
        subscriptions_list_items: "{{ (subscriptions_list.get('items', [])) if (subscriptions_list is mapping) else [] }}"
        installplans_list_items: "{{ (installplans_list.get('items', [])) if (installplans_list is mapping) else [] }}"
        operatorgroups_list_items: "{{ (operatorgroups_list.get('items', [])) if (operatorgroups_list is mapping) else [] }}"

    - name: Analyze operator health
      set_fact:
        operator_health_analysis:
          total_csvs: "{{ csv_list_items | length }}"
          total_subscriptions: "{{ subscriptions_list_items | length }}"
          total_install_plans: "{{ installplans_list_items | length }}"
          total_operator_groups: "{{ operatorgroups_list_items | length }}"
          csvs_by_namespace: "{{ csv_list_items | groupby('metadata.namespace') | map('first') | list }}"
          subscriptions_by_namespace: "{{ subscriptions_list_items | groupby('metadata.namespace') | map('first') | list }}"

    - name: Analyze operator versions
      set_fact:
        operator_versions_analysis:
          csv_versions: "{{ csv_list_items | map(attribute='spec.version') | unique | list }}"
          subscription_versions: "{{ subscriptions_list_items | map(attribute='spec.channel') | unique | list }}"
          operator_names: "{{ csv_list_items | map(attribute='spec.displayName') | unique | list }}"

    - name: Initialize operator issues
      set_fact:
        operator_issues: []

    - name: Check operator issues
      block:
        - name: Check for failed install plans
          set_fact:
            operator_issues: "{{ operator_issues + ['Some install plans may have failed'] }}"
          when: installplans_list_items | selectattr('status.phase', 'equalto', 'Failed') | list | length > 0

        - name: Check for subscription issues
          set_fact:
            operator_issues: "{{ operator_issues + ['Some subscriptions may have issues'] }}"
          when: subscriptions_list_items | selectattr('status.conditions', 'defined') | selectattr('status.conditions', 'selectattr', 'status', 'equalto', 'False') | list | length > 0

        - name: Check for CSV issues
          set_fact:
            operator_issues: "{{ operator_issues + ['Some cluster service versions may have issues'] }}"
          when: csv_list_items | selectattr('status.phase', 'defined') | selectattr('status.phase', 'not', 'equalto', 'Succeeded') | list | length > 0

    - name: Update architecture analysis with operator analysis
      set_fact:
        architecture_analysis:
          operator_analysis:
            operator_health: "{{ operator_health_analysis }}"
            operator_versions: "{{ operator_versions_analysis }}"
            operator_issues: "{{ operator_issues }}"

    - name: Set fact for operator analysis status
      set_fact:
        analysis_status:
          operator_analysis: true

    - name: Display operator analysis status
      debug:
        msg: "Operator health analysis completed successfully"

  rescue:
    - name: Handle operator analysis failure
      debug:
        msg: "Failed to analyze operator health: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for operator analysis status
      set_fact:
        analysis_status:
          operator_analysis: false

---
# Análise de operators feita NO REMOTO (script) e só o resumo vem ao controlador.
# Evita slurp + from_json do operators.json inteiro no controlador (trava servidor).
- name: Analyze operator health
  block:
    - name: Copy operator summary script to remote
      copy:
        src: summarize_operators.py
        dest: "{{ data_output_path }}/summarize_operators.py"
        mode: '0755'

    - name: Run operator analysis on remote (summary stays on remote, small file only)
      command: "python3 {{ data_output_path }}/summarize_operators.py {{ data_output_path }}/operators.json {{ data_output_path }}/operator_analysis_summary.json"
      args:
        chdir: "{{ data_output_path }}"
      register: operator_summary_result
      no_log: true
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Load operator analysis summary from host (arquivo pequeno)
      slurp:
        src: "{{ data_output_path }}/operator_analysis_summary.json"
      register: operator_summary_slurp
      when:
        - data_collection_completed | bool
        - not ansible_check_mode | bool
      ignore_errors: true
      failed_when: false

    - name: Set operator analysis from summary (sem parse do JSON gigante no controlador)
      set_fact:
        architecture_analysis: "{{ architecture_analysis | default({}) | combine({'operator_analysis': (operator_summary_slurp.content | b64decode | from_json)}}) }}"
      when:
        - operator_summary_slurp is defined
        - operator_summary_slurp.content is defined
        - (operator_summary_slurp.content | length) > 0

    - name: Set default operator analysis when summary missing
      set_fact:
        architecture_analysis: "{{ architecture_analysis | default({}) | combine({'operator_analysis': {'operator_health': {'total_csvs': 0, 'total_subscriptions': 0, 'total_install_plans': 0, 'total_operator_groups': 0}, 'operator_versions': {'csv_versions': [], 'subscription_versions': [], 'operator_names': []}, 'operator_issues': ['Operator analysis not run or summary missing']}}) }}"
      when: (architecture_analysis | default({})).get('operator_analysis') is not defined

    - name: Set fact for operator analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'operator_analysis': (operator_summary_slurp is defined and operator_summary_slurp.content is defined and (operator_summary_slurp.content | length) > 0)) }}"

    - name: Display operator analysis status
      debug:
        msg: "Operator health analysis completed (summary from remote)"

  rescue:
    - name: Handle operator analysis failure
      debug:
        msg: "Failed to analyze operator health: {{ ansible_failed_result.msg }}"
      
    - name: Set fact for operator analysis status
      set_fact:
        analysis_status: "{{ analysis_status | default({}) | combine({'operator_analysis': false}) }}"
    
    - name: Ensure operator_analysis key exists on failure
      set_fact:
        architecture_analysis: "{{ architecture_analysis | default({}) | combine({'operator_analysis': {'operator_health': {'total_csvs': 0, 'total_subscriptions': 0, 'total_install_plans': 0, 'total_operator_groups': 0}, 'operator_versions': {'csv_versions': [], 'subscription_versions': [], 'operator_names': []}, 'operator_issues': ['Analysis failed']}}) }}"
      when: (architecture_analysis | default({})).get('operator_analysis') is not defined

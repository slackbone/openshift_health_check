---
# Playbook principal para Avaliação de Saúde do OpenShift
# Este playbook executa uma análise abrangente de clusters OpenShift 4.17
# NOTA: Se você está vendo execução duplicada, verifique:
# 1. Se há múltiplos hosts no inventory (use --limit para especificar um host)
# 2. Se há aliases duplicados no inventory (ex: 'dev' e 'development-cluster' apontando para o mesmo host)
# 3. Se o inventory está sendo carregado duas vezes (verifique ansible.cfg)
- name: Avaliação de Saúde do OpenShift
  hosts: all
  gather_facts: true
  vars:
    # Configurações de conexão com o cluster OpenShift
    # Aceita credenciais via:
    # - inventário (openshift_cluster_url ou cluster_url / openshift_token / openshift_username por host ou grupo)
    # - linha de comando (-e cluster_url/cluster_token/cluster_username)
    openshift_cluster_url: "{{ cluster_url | default(hostvars[inventory_hostname].openshift_cluster_url | default(hostvars[inventory_hostname].cluster_url | default(''))) }}"
    openshift_token: "{{ cluster_token | default(hostvars[inventory_hostname].openshift_token | default('')) }}"
    openshift_username: "{{ cluster_username | default(hostvars[inventory_hostname].openshift_username | default('')) }}"
    # Base path no remoto: HOME pode ser string vazia no bastion; garantir fallback para /tmp
    _remote_base: "{{ (ansible_env.HOME | default('')) or '/tmp' }}"
    # Diretório para kubeconfig: no host remoto (bastion) usa HOME do usuário remoto;
    # em execução local usa playbook_dir para não criar caminhos do controlador no remoto
    kubeconfig_dir: "{{ (ansible_connection == 'local' or inventory_hostname == 'localhost') | ternary(playbook_dir + '/.kube', _remote_base + '/.ansible_openshift_health_check/.kube') }}"
    openshift_kubeconfig: "{{ kubeconfig_path | default(kubeconfig_dir + '/config') }}"
    # Saída dos relatórios: no remoto usa dir sob HOME (ou /tmp); em local usa playbook_dir/../reports
    output_dir: "{{ (ansible_connection == 'local' or inventory_hostname == 'localhost') | ternary(playbook_dir + '/../reports', _remote_base + '/openshift_health_check_reports') }}"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    # execution_id e paths serão definidos nas pre_tasks após cluster_name ser definido
    execution_id: ""
    reports_output_dir: ""
    report_output_path: ""
    
  pre_tasks:
    # Mostrar URL e host resolvidos (ajuda a verificar se o inventário está sendo aplicado)
    - name: Mostrar URL do cluster resolvida para o host
      debug:
        msg: "Host: {{ inventory_hostname }} | openshift_cluster_url: {{ openshift_cluster_url }}"
      when: openshift_cluster_url is defined and openshift_cluster_url != ""

    - name: Falhar se openshift_cluster_url estiver vazia
      fail:
        msg: |
          openshift_cluster_url não está definida para o host '{{ inventory_hostname }}'.
          Defina no inventário (por host ou grupo) como openshift_cluster_url ou cluster_url,
          ou passe na linha de comando: -e cluster_url="https://api.seu-cluster:6443"
      when: openshift_cluster_url is not defined or openshift_cluster_url == ""

    # Definir cluster_name evitando loop recursivo
    # Primeiro tenta da variável -e cluster_name, depois do inventário, depois default
    - name: Definir cluster_name a partir de variáveis
      set_fact:
        cluster_name: "{{ cluster_name if cluster_name is defined and cluster_name != '' else (hostvars[inventory_hostname]['cluster_name'] | default('openshift-cluster')) }}"
    
    # Recalcular execution_id e paths após definir cluster_name
    - name: Recalcular execution_id e paths
      set_fact:
        execution_id: "{{ cluster_name }}_{{ timestamp }}"
        reports_output_dir: "{{ output_dir }}/{{ execution_id }}"
        report_output_path: "{{ reports_output_dir }}"
    # Criar diretório para kubeconfig gerado dinamicamente
    - name: Criar diretório para kubeconfig
      file:
        path: "{{ kubeconfig_dir }}"
        state: directory
        mode: '0700'
      when: kubeconfig_path is not defined or kubeconfig_path == ""
    
    # Gerar kubeconfig dinamicamente usando usuário e token
    - name: Gerar kubeconfig dinamicamente usando oc login
      shell: |
        oc login {{ openshift_cluster_url }} \
          --token={{ openshift_token }} \
          --username={{ openshift_username }} \
          --insecure-skip-tls-verify=true \
          --kubeconfig={{ openshift_kubeconfig }}
      register: oc_login_result
      failed_when: false
      changed_when: oc_login_result.rc == 0
      when: 
        - openshift_cluster_url != ""
        - openshift_token != ""
        - openshift_username != ""
        - (kubeconfig_path is not defined or kubeconfig_path == "")
      environment:
        KUBECONFIG: "{{ openshift_kubeconfig }}"
    
    # Alternativa: Gerar kubeconfig manualmente se oc login falhar (tentar antes de falhar)
    - name: Gerar kubeconfig manualmente (fallback)
      copy:
        content: |
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              insecure-skip-tls-verify: true
              server: {{ openshift_cluster_url }}
            name: {{ cluster_name }}
          contexts:
          - context:
              cluster: {{ cluster_name }}
              namespace: default
              user: {{ openshift_username }}/{{ cluster_name }}
            name: default/{{ cluster_name }}/{{ openshift_username }}
          current-context: default/{{ cluster_name }}/{{ openshift_username }}
          users:
          - name: {{ openshift_username }}/{{ cluster_name }}
            user:
              token: {{ openshift_token }}
        dest: "{{ openshift_kubeconfig }}"
        mode: '0600'
      when:
        - openshift_cluster_url != ""
        - openshift_token != ""
        - openshift_username != ""
        - (kubeconfig_path is not defined or kubeconfig_path == "")
        - (oc_login_result is not defined or (oc_login_result.rc is defined and oc_login_result.rc != 0))
      ignore_errors: true

    # Verificar se o kubeconfig existe (após oc login ou fallback)
    - name: Verificar se kubeconfig foi gerado
      stat:
        path: "{{ openshift_kubeconfig }}"
      register: kubeconfig_stat
      when: (kubeconfig_path is not defined or kubeconfig_path == "")

    # Falhar só se ainda não existir arquivo após fallback
    - name: Falhar se kubeconfig não foi gerado
      fail:
        msg: "Não foi possível gerar o kubeconfig. Verifique se oc está instalado e se as credenciais estão corretas."
      when:
        - (kubeconfig_path is not defined or kubeconfig_path == "")
        - (kubeconfig_stat is not defined or not kubeconfig_stat.stat.exists)
    
    # Validação das variáveis obrigatórias
    - name: Validar variáveis obrigatórias (URL e Token)
      fail:
        msg: "Variável obrigatória '{{ item }}' não foi definida"
      when: 
        - item is not defined or item == ""
      loop:
        - "{{ openshift_cluster_url }}"
        - "{{ openshift_token }}"
    
    # Validar usuário apenas se kubeconfig não foi fornecido
    - name: Validar usuário quando kubeconfig não fornecido
      fail:
        msg: "Variável 'openshift_username' é obrigatória quando kubeconfig não é fornecido. Forneça via -e cluster_username ou no inventário."
      when:
        - (kubeconfig_path is not defined or kubeconfig_path == "")
        - (openshift_username is not defined or openshift_username == "")
        
    # Criação da estrutura de diretórios organizada
    - name: Criar diretório principal da execução
      file:
        path: "{{ reports_output_dir }}"
        state: directory
        mode: '0755'
        
    # Criação dos diretórios por tipo de relatório
    - name: Criar diretórios por tipo de relatório
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ reports_output_dir }}/data_collection"
        - "{{ reports_output_dir }}/architecture_analysis"
        - "{{ reports_output_dir }}/security_analysis"
        - "{{ reports_output_dir }}/best_practices_analysis"
        - "{{ reports_output_dir }}/resource_optimization"
        - "{{ reports_output_dir }}/consolidated"
        - "{{ reports_output_dir }}/html"
        
    # Criação dos diretórios HTML por tipo
    - name: Criar diretórios HTML por tipo
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ reports_output_dir }}/html/data_collection"
        - "{{ reports_output_dir }}/html/architecture_analysis"
        - "{{ reports_output_dir }}/html/security_analysis"
        - "{{ reports_output_dir }}/html/best_practices_analysis"
        - "{{ reports_output_dir }}/html/resource_optimization"
        - "{{ reports_output_dir }}/html/consolidated"
        

  roles:
    # Role para coleta de dados do cluster
    - role: data_collector
      tags: ['coleta_dados', 'todos']
      
    # Role para análise de arquitetura
    - role: architecture_analyzer
      tags: ['arquitetura', 'todos']
      
    # Role para análise de segurança
    - role: security_analyzer
      tags: ['seguranca', 'todos']
      
    # Role para análise de boas práticas
    - role: best_practices_analyzer
      tags: ['boas_praticas', 'todos']
      
    # Role para otimização de recursos
    - role: resource_optimizer
      tags: ['recursos', 'todos']
      
    # Role para geração de relatórios
    - role: report_generator
      tags: ['relatorios', 'todos']

  post_tasks:
    # Exibir mensagem de conclusão
    - name: Exibir mensagem de conclusão
      debug:
        msg: |
          Avaliação de Saúde do OpenShift concluída com sucesso!
          
          Cluster: {{ cluster_name }}
          Execução: {{ execution_id }}
          Relatórios gerados em: {{ report_output_path }}
          
          Estrutura de Relatórios:
          
          Relatórios HTML (Executivos):
          - Relatório Consolidado: {{ report_output_path }}/html/consolidated/consolidated_health_check_report.html
          - Coleta de Dados: {{ report_output_path }}/html/data_collection/data_collection_report.html
          - Análise de Arquitetura: {{ report_output_path }}/html/architecture_analysis/architecture_analysis_report.html
          - Análise de Segurança: {{ report_output_path }}/html/security_analysis/security_analysis_report.html
          - Melhores Práticas: {{ report_output_path }}/html/best_practices_analysis/best_practices_analysis_report.html
          - Otimização de Recursos: {{ report_output_path }}/html/resource_optimization/resource_optimization_report.html
          
          Relatórios Markdown (Detalhados):
          - Coleta de Dados: {{ report_output_path }}/data_collection/data_collection_report.md
          - Análise de Arquitetura: {{ report_output_path }}/architecture_analysis/architecture_analysis_report.md
          - Análise de Segurança: {{ report_output_path }}/security_analysis/security_analysis_report.md
          - Melhores Práticas: {{ report_output_path }}/best_practices_analysis/best_practices_analysis_report.md
          - Otimização de Recursos: {{ report_output_path }}/resource_optimization/resource_optimization_report.md
          - Relatório Consolidado: {{ report_output_path }}/consolidated/consolidated_health_check_report.md
          
          Para visualizar o relatório HTML executivo, abra: file://{{ report_output_path }}/html/consolidated/consolidated_health_check_report.html

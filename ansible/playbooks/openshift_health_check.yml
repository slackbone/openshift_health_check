---
# Playbook principal para Avalia칞칚o de Sa칰de do OpenShift
# Este playbook executa uma an치lise abrangente de clusters OpenShift 4.17
- name: Avalia칞칚o de Sa칰de do OpenShift
  hosts: localhost
  gather_facts: true
  vars:
    # Configura칞칫es de conex칚o com o cluster OpenShift
    # Aceita credenciais via:
    # - invent치rio (openshift_cluster_url/openshift_token/openshift_username por host)
    # - linha de comando (-e cluster_url/cluster_token/cluster_username)
    openshift_cluster_url: "{{ cluster_url | default(hostvars[inventory_hostname].openshift_cluster_url | default('')) }}"
    openshift_token: "{{ cluster_token | default(hostvars[inventory_hostname].openshift_token | default('')) }}"
    openshift_username: "{{ cluster_username | default(hostvars[inventory_hostname].openshift_username | default('')) }}"
    # Diret칩rio tempor치rio para kubeconfig gerado dinamicamente
    kubeconfig_dir: "{{ playbook_dir }}/.kube"
    openshift_kubeconfig: "{{ kubeconfig_path | default(kubeconfig_dir + '/config') }}"
    # Configura칞칫es de sa칤da dos relat칩rios
    output_dir: "{{ playbook_dir }}/../reports"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    cluster_name: "{{ cluster_name | default('openshift-cluster') }}"
    execution_id: "{{ cluster_name }}_{{ timestamp }}"
    reports_output_dir: "{{ output_dir }}/{{ execution_id }}"
    report_output_path: "{{ reports_output_dir }}"
    
  pre_tasks:
    # Criar diret칩rio para kubeconfig gerado dinamicamente
    - name: Criar diret칩rio para kubeconfig
      file:
        path: "{{ kubeconfig_dir }}"
        state: directory
        mode: '0700'
      when: kubeconfig_path is not defined or kubeconfig_path == ""
    
    # Gerar kubeconfig dinamicamente usando usu치rio e token
    - name: Gerar kubeconfig dinamicamente usando oc login
      shell: |
        oc login {{ openshift_cluster_url }} \
          --token={{ openshift_token }} \
          --username={{ openshift_username }} \
          --insecure-skip-tls-verify=true \
          --kubeconfig={{ openshift_kubeconfig }}
      register: oc_login_result
      failed_when: false
      changed_when: oc_login_result.rc == 0
      when: 
        - openshift_cluster_url != ""
        - openshift_token != ""
        - openshift_username != ""
        - (kubeconfig_path is not defined or kubeconfig_path == "")
      environment:
        KUBECONFIG: "{{ openshift_kubeconfig }}"
    
    # Verificar se o kubeconfig foi gerado com sucesso
    - name: Verificar se kubeconfig foi gerado
      stat:
        path: "{{ openshift_kubeconfig }}"
      register: kubeconfig_stat
      when: (kubeconfig_path is not defined or kubeconfig_path == "")
    
    # Falhar se kubeconfig n칚o foi gerado e oc login falhou
    - name: Falhar se kubeconfig n칚o foi gerado
      fail:
        msg: "N칚o foi poss칤vel gerar o kubeconfig. Verifique se oc est치 instalado e se as credenciais est칚o corretas."
      when:
        - (kubeconfig_path is not defined or kubeconfig_path == "")
        - (oc_login_result is defined and oc_login_result.rc != 0)
        - (kubeconfig_stat is not defined or not kubeconfig_stat.stat.exists)
    
    # Alternativa: Gerar kubeconfig manualmente se oc login falhar ou n칚o dispon칤vel
    - name: Gerar kubeconfig manualmente (fallback)
      copy:
        content: |
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              insecure-skip-tls-verify: true
              server: {{ openshift_cluster_url }}
            name: {{ cluster_name }}
          contexts:
          - context:
              cluster: {{ cluster_name }}
              namespace: default
              user: {{ openshift_username }}/{{ cluster_name }}
            name: default/{{ cluster_name }}/{{ openshift_username }}
          current-context: default/{{ cluster_name }}/{{ openshift_username }}
          users:
          - name: {{ openshift_username }}/{{ cluster_name }}
            user:
              token: {{ openshift_token }}
        dest: "{{ openshift_kubeconfig }}"
        mode: '0600'
      when: 
        - openshift_cluster_url != ""
        - openshift_token != ""
        - openshift_username != ""
        - (kubeconfig_path is not defined or kubeconfig_path == "")
        - (oc_login_result is not defined or (oc_login_result.rc is defined and oc_login_result.rc != 0))
      ignore_errors: true
    
    # Valida칞칚o das vari치veis obrigat칩rias
    - name: Validar vari치veis obrigat칩rias (URL e Token)
      fail:
        msg: "Vari치vel obrigat칩ria '{{ item }}' n칚o foi definida"
      when: 
        - item is not defined or item == ""
      loop:
        - "{{ openshift_cluster_url }}"
        - "{{ openshift_token }}"
    
    # Validar usu치rio apenas se kubeconfig n칚o foi fornecido
    - name: Validar usu치rio quando kubeconfig n칚o fornecido
      fail:
        msg: "Vari치vel 'openshift_username' 칠 obrigat칩ria quando kubeconfig n칚o 칠 fornecido. Forne칞a via -e cluster_username ou no invent치rio."
      when:
        - (kubeconfig_path is not defined or kubeconfig_path == "")
        - (openshift_username is not defined or openshift_username == "")
        
    # Cria칞칚o da estrutura de diret칩rios organizada
    - name: Criar diret칩rio principal da execu칞칚o
      file:
        path: "{{ reports_output_dir }}"
        state: directory
        mode: '0755'
        
    # Cria칞칚o dos diret칩rios por tipo de relat칩rio
    - name: Criar diret칩rios por tipo de relat칩rio
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ reports_output_dir }}/data_collection"
        - "{{ reports_output_dir }}/architecture_analysis"
        - "{{ reports_output_dir }}/security_analysis"
        - "{{ reports_output_dir }}/best_practices_analysis"
        - "{{ reports_output_dir }}/resource_optimization"
        - "{{ reports_output_dir }}/consolidated"
        - "{{ reports_output_dir }}/html"
        
    # Cria칞칚o dos diret칩rios HTML por tipo
    - name: Criar diret칩rios HTML por tipo
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ reports_output_dir }}/html/data_collection"
        - "{{ reports_output_dir }}/html/architecture_analysis"
        - "{{ reports_output_dir }}/html/security_analysis"
        - "{{ reports_output_dir }}/html/best_practices_analysis"
        - "{{ reports_output_dir }}/html/resource_optimization"
        - "{{ reports_output_dir }}/html/consolidated"
        

  roles:
    # Role para coleta de dados do cluster
    - role: data_collector
      tags: ['coleta_dados', 'todos']
      
    # Role para an치lise de arquitetura
    - role: architecture_analyzer
      tags: ['arquitetura', 'todos']
      
    # Role para an치lise de seguran칞a
    - role: security_analyzer
      tags: ['seguranca', 'todos']
      
    # Role para an치lise de boas pr치ticas
    - role: best_practices_analyzer
      tags: ['boas_praticas', 'todos']
      
    # Role para otimiza칞칚o de recursos
    - role: resource_optimizer
      tags: ['recursos', 'todos']
      
    # Role para gera칞칚o de relat칩rios
    - role: report_generator
      tags: ['relatorios', 'todos']

  post_tasks:
    # Exibir mensagem de conclus칚o
    - name: Exibir mensagem de conclus칚o
      debug:
        msg: |
          Avalia칞칚o de Sa칰de do OpenShift conclu칤da com sucesso!
          
          Cluster: {{ cluster_name }}
          Execu칞칚o: {{ execution_id }}
          Relat칩rios gerados em: {{ report_output_path }}
          
          Estrutura de Relat칩rios:
          
          游늵 Relat칩rios HTML (Executivos):
          - Relat칩rio Consolidado: {{ report_output_path }}/html/consolidated/consolidated_health_check_report.html
          - Coleta de Dados: {{ report_output_path }}/html/data_collection/data_collection_report.html
          - An치lise de Arquitetura: {{ report_output_path }}/html/architecture_analysis/architecture_analysis_report.html
          - An치lise de Seguran칞a: {{ report_output_path }}/html/security_analysis/security_analysis_report.html
          - Melhores Pr치ticas: {{ report_output_path }}/html/best_practices_analysis/best_practices_analysis_report.html
          - Otimiza칞칚o de Recursos: {{ report_output_path }}/html/resource_optimization/resource_optimization_report.html
          
          游늶 Relat칩rios Markdown (Detalhados):
          - Coleta de Dados: {{ report_output_path }}/data_collection/data_collection_report.md
          - An치lise de Arquitetura: {{ report_output_path }}/architecture_analysis/architecture_analysis_report.md
          - An치lise de Seguran칞a: {{ report_output_path }}/security_analysis/security_analysis_report.md
          - Melhores Pr치ticas: {{ report_output_path }}/best_practices_analysis/best_practices_analysis_report.md
          - Otimiza칞칚o de Recursos: {{ report_output_path }}/resource_optimization/resource_optimization_report.md
          - Relat칩rio Consolidado: {{ report_output_path }}/consolidated/consolidated_health_check_report.md
          
          Para visualizar o relat칩rio HTML executivo, abra: file://{{ report_output_path }}/html/consolidated/consolidated_health_check_report.html

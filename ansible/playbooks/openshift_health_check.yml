---
# Playbook principal para Avalia칞칚o de Sa칰de do OpenShift
# Este playbook executa uma an치lise abrangente de clusters OpenShift 4.17
- name: Avalia칞칚o de Sa칰de do OpenShift
  hosts: localhost
  gather_facts: true
  vars:
    # Configura칞칫es de conex칚o com o cluster OpenShift
    openshift_cluster_url: "{{ cluster_url | default('') }}"
    openshift_token: "{{ cluster_token | default('') }}"
    openshift_kubeconfig: "{{ kubeconfig_path | default('~/.kube/config') }}"
    # Configura칞칫es de sa칤da dos relat칩rios
    output_dir: "{{ playbook_dir }}/../reports"
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    cluster_name: "{{ cluster_name | default('openshift-cluster') }}"
    execution_id: "{{ cluster_name }}_{{ timestamp }}"
    reports_output_dir: "{{ output_dir }}/{{ execution_id }}"
    report_output_path: "{{ reports_output_dir }}"
    
  pre_tasks:
    # Valida칞칚o das vari치veis obrigat칩rias
    - name: Validar vari치veis obrigat칩rias
      fail:
        msg: "Vari치vel obrigat칩ria '{{ item }}' n칚o foi definida"
      when: 
        - item is not defined or item == ""
      loop:
        - "{{ openshift_cluster_url }}"
        - "{{ openshift_token }}"
        
    # Cria칞칚o da estrutura de diret칩rios organizada
    - name: Criar diret칩rio principal da execu칞칚o
      file:
        path: "{{ reports_output_dir }}"
        state: directory
        mode: '0755'
        
    # Cria칞칚o dos diret칩rios por tipo de relat칩rio
    - name: Criar diret칩rios por tipo de relat칩rio
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ reports_output_dir }}/data_collection"
        - "{{ reports_output_dir }}/architecture_analysis"
        - "{{ reports_output_dir }}/security_analysis"
        - "{{ reports_output_dir }}/best_practices_analysis"
        - "{{ reports_output_dir }}/resource_optimization"
        - "{{ reports_output_dir }}/consolidated"
        - "{{ reports_output_dir }}/html"
        
    # Cria칞칚o dos diret칩rios HTML por tipo
    - name: Criar diret칩rios HTML por tipo
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ reports_output_dir }}/html/data_collection"
        - "{{ reports_output_dir }}/html/architecture_analysis"
        - "{{ reports_output_dir }}/html/security_analysis"
        - "{{ reports_output_dir }}/html/best_practices_analysis"
        - "{{ reports_output_dir }}/html/resource_optimization"
        - "{{ reports_output_dir }}/html/consolidated"
        

  roles:
    # Role para coleta de dados do cluster
    - role: data_collector
      tags: ['coleta_dados', 'todos']
      
    # Role para an치lise de arquitetura
    - role: architecture_analyzer
      tags: ['arquitetura', 'todos']
      
    # Role para an치lise de seguran칞a
    - role: security_analyzer
      tags: ['seguranca', 'todos']
      
    # Role para an치lise de boas pr치ticas
    - role: best_practices_analyzer
      tags: ['boas_praticas', 'todos']
      
    # Role para otimiza칞칚o de recursos
    - role: resource_optimizer
      tags: ['recursos', 'todos']
      
    # Role para gera칞칚o de relat칩rios
    - role: report_generator
      tags: ['relatorios', 'todos']

  post_tasks:
    # Exibir mensagem de conclus칚o
    - name: Exibir mensagem de conclus칚o
      debug:
        msg: |
          Avalia칞칚o de Sa칰de do OpenShift conclu칤da com sucesso!
          
          Cluster: {{ cluster_name }}
          Execu칞칚o: {{ execution_id }}
          Relat칩rios gerados em: {{ report_output_path }}
          
          Estrutura de Relat칩rios:
          
          游늵 Relat칩rios HTML (Executivos):
          - Relat칩rio Consolidado: {{ report_output_path }}/html/consolidated/consolidated_health_check_report.html
          - Coleta de Dados: {{ report_output_path }}/html/data_collection/data_collection_report.html
          - An치lise de Arquitetura: {{ report_output_path }}/html/architecture_analysis/architecture_analysis_report.html
          - An치lise de Seguran칞a: {{ report_output_path }}/html/security_analysis/security_analysis_report.html
          - Melhores Pr치ticas: {{ report_output_path }}/html/best_practices_analysis/best_practices_analysis_report.html
          - Otimiza칞칚o de Recursos: {{ report_output_path }}/html/resource_optimization/resource_optimization_report.html
          
          游늶 Relat칩rios Markdown (Detalhados):
          - Coleta de Dados: {{ report_output_path }}/data_collection/data_collection_report.md
          - An치lise de Arquitetura: {{ report_output_path }}/architecture_analysis/architecture_analysis_report.md
          - An치lise de Seguran칞a: {{ report_output_path }}/security_analysis/security_analysis_report.md
          - Melhores Pr치ticas: {{ report_output_path }}/best_practices_analysis/best_practices_analysis_report.md
          - Otimiza칞칚o de Recursos: {{ report_output_path }}/resource_optimization/resource_optimization_report.md
          - Relat칩rio Consolidado: {{ report_output_path }}/consolidated/consolidated_health_check_report.md
          
          Para visualizar o relat칩rio HTML executivo, abra: file://{{ report_output_path }}/html/consolidated/consolidated_health_check_report.html
